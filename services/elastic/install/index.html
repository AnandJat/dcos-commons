<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">








<head>
<title>Elastic: Install and Customize</title>
<link rel="stylesheet" type="text/css" media="all" href="/dcos-commons/style/layout.css" />
<link rel="shortcut icon" type="image/png" href="https://mesosphere.com/favicon.ico"/>
<!-- The Dropdown library is written by Stephen Morley, licensed CC0 1.0 Universal (Public Domain Dedication)-->
<link rel="stylesheet" type="text/css" media="all" href="/dcos-commons/style/Dropdown.css" />
<script src="/dcos-commons/style/Dropdown.js"></script>
<style type="text/css">
/* set the background color of menu items */
.dropdown, .dropdown ul { background: #555555; clear: both; }
/* set the background color of active items */
.dropdown li:hover > a, .dropdown li:hover > span, .dropdown li.dropdownOpen > a, .dropdown li.dropdownOpen > span { background: #af87e0; }
/* pad items, set their text color, and fade their background color */
.dropdown a, .dropdown span { padding: 0.25em 0.5em; color: white; transition: background 0.2s; }
/* show '+' on expandable items */
.dropdown span:after { content: " +"; }

/* toc style: remove extra margin between elements */
.section-nav ul { margin: 0; }
</style>
</head>

<body>
<div id="wrapper">

<a href="/dcos-commons">
<img style="float: left; margin-bottom: 2em" src="https://mesosphere.com/wp-content/themes/mesosphere/library/images/assets/dcos-sdk-logo.png" width="250" alt="DC/OS Software Development Kit" />
</a>
<img style="float: right" src="https://img.shields.io/badge/Status-Alpha-BF97F0.svg?style=flat-square" alt="Status: Alpha" />

<ul class="dropdown" style="clear: both">
  <li>
    <a href="/dcos-commons">Home</a>
  </li>
  <li>
    <span>Documentation</span>
    <ul>
      
      
      
      
      <li><a href="/dcos-commons/operations-guide/">SDK Operations Guide</a></li>
      
      
      
      
      
      <li><a href="/dcos-commons/developer-guide/">SDK Developer Guide</a></li>
      
      
      
      <li><a href="/dcos-commons/yaml-reference/">YAML Reference</a></li>
      
      
      
      <li><a href="/dcos-commons/faq/">Frequently Asked Questions</a></li>
      
      
      
      <li><a href="/dcos-commons/glossary/">Glossary</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li><a href="/dcos-commons/reference/api">Javadoc Reference</a></li>
      <li><a href="/dcos-commons/reference/swagger-api">REST APIs</a></li>
    </ul>
  </li>
  <li>
    <span>Tutorials</span>
    <ul>
      
      
      
      <li><a href="/dcos-commons/tutorials/kafka-tutorial/">Kafka Tutorial</a></li>
      
      <li><a href="/dcos-commons/tutorials/secrets-tutorial/">Secrets Tutorial</a></li>
      
    </ul>
  </li>
  <li>
    <span>Services</span>
    <ul>
      
      
      
      
      <li>
        
        <span>Cassandra</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/service-settings/">Service Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/cassandra-settings/">Cassandra Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/node-settings/">Node Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/disaster-recovery/">Disaster Recovery</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Elastic</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/elastic/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/elastic-x-pack/">X-Pack</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/custom-elasticsearch-yaml/">Custom Elasticsearch YAML</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/disaster-recovery/">Disaster Recovery</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>HDFS</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/kerberos/">Kerberos</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Kafka</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/kafka/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/security/">Security</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
    </ul>
  </li>
  <li><a href="https://github.com/mesosphere/dcos-commons/blob/master/CONTRIBUTING.md">Contributing</a></li>
  <li><a href="http://chat.dcos.io" target="_blank">Slack</a></li>
</ul>
<h1>Elastic: Install and Customize</h1>
<div id="content">

<p>The default DC/OS Elastic installation provides reasonable defaults for trying out the service, but may not be sufficient for production use. You may require a different configuration depending on the context of the deployment.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Depending on your security mode in Enterprise DC/OS, you may <a href="">need to provision a service account</a> before installing. Only someone with <code class="highlighter-rouge">superuser</code> permission can create the service account.
    <ul>
      <li><code class="highlighter-rouge">strict</code> <a href="https://docs.mesosphere.com/latest/installing/custom/configuration-parameters/#security">security mode</a> requires a service account.</li>
      <li><code class="highlighter-rouge">permissive</code> security mode a service account is optional.</li>
      <li><code class="highlighter-rouge">disabled</code> security mode does not require a service account.</li>
    </ul>
  </li>
  <li>
    <p>Your cluster must have at least three private nodes.</p>
  </li>
  <li></li>
</ul>

<h2 id="default-installation">Default Installation</h2>

<p>To start a basic test cluster with three master nodes, two data nodes, and one coordinator node, run the following command on the DC/OS CLI. Enterprise DC/OS users must follow additional instructions. <a href="">More information about installing Elastic on Enterprise DC/OS</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos package <span class="nb">install </span>beta-elastic
</code></pre></div></div>

<p>This command creates a new instance with the default name <code class="highlighter-rouge">elastic</code>. Two instances cannot share the same name, so installing additional instances beyond the default instance requires <a href="#custom-installation">customizing the <code class="highlighter-rouge">name</code> at install time</a> for each additional instance.</p>

<p>All <code class="highlighter-rouge">dcos beta-elastic</code> CLI commands have a <code class="highlighter-rouge">--name</code> argument allowing the user to specify which instance to query. If you do not specify a service name, the CLI assumes a default value matching the package name, i.e. <code class="highlighter-rouge">beta-elastic</code>. The default value for <code class="highlighter-rouge">--name</code> can be customized via the DC/OS CLI configuration:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos beta-elastic <span class="nt">--name</span><span class="o">=</span>elastic &lt;cmd&gt;
</code></pre></div></div>

<p><strong>Note:</strong> Alternatively, you can <a href="https://docs.mesosphere.com/latest/deploying-services/install/">install from the DC/OS web interface</a>. If you install from the web interface, you must install the DC/OS CLI subcommands separately. From the DC/OS CLI, enter:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dcos package <span class="nb">install </span>beta-elastic <span class="nt">--cli</span>
</code></pre></div></div>

<h2 id="integration-with-dcos-access-controls">Integration with DC/OS access controls</h2>

<p>In Enterprise DC/OS 1.10 and above, you can integrate your SDK-based service with DC/OS ACLs to grant users and groups access to only certain services. You do this by installing your service into a folder, and then restricting access to some number of folders. Folders also allow you to namespace services. For instance, <code class="highlighter-rouge">staging/elastic</code> and <code class="highlighter-rouge">production/elastic</code>.</p>

<p>Steps:</p>

<ol>
  <li>In the DC/OS GUI, create a group, then add a user to the group. Or, just create a user. Click <strong>Organization</strong> &gt; <strong>Groups</strong> &gt; <strong>+</strong> or <strong>Organization</strong> &gt; <strong>Users</strong> &gt; <strong>+</strong>. If you create a group, you must also create a user and add them to the group.</li>
  <li>
    <p>Give the user permissions for the folder where you will install your service. In this example, we are creating a user called <code class="highlighter-rouge">developer</code>, who will have access to the <code class="highlighter-rouge">/testing</code> folder.</p>

    <p>Select the group or user you created. Select <strong>ADD PERMISSION</strong> and then toggle to <strong>INSERT PERMISSION STRING</strong>. Add each of the following permissions to your user or group, and then click <strong>ADD PERMISSIONS</strong>.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  dcos:adminrouter:service:marathon full
  dcos:service:marathon:marathon:services:/testing full
  dcos:adminrouter:ops:mesos full
  dcos:adminrouter:ops:slave full
</code></pre></div>    </div>
  </li>
  <li>Install your service into a folder called <code class="highlighter-rouge">test</code>. Go to <strong>Catalog</strong>, then search for <strong>beta-elastic</strong>.</li>
  <li>
    <p>Click <strong>CONFIGURE</strong> and change the service name to <code class="highlighter-rouge">/testing/elastic</code>, then deploy.</p>

    <p>The slashes in your service name are interpreted as folders. You are deploying <code class="highlighter-rouge">elastic</code> in the <code class="highlighter-rouge">/testing</code> folder. Any user with access to the <code class="highlighter-rouge">/testing</code> folder will have access to the service.</p>
  </li>
</ol>

<p><strong>Important:</strong></p>
<ul>
  <li>Services cannot be renamed. Because the location of the service is specified in the name, you cannot move services between folders.</li>
  <li>DC/OS 1.9 and earlier does not accept slashes in service names. You may be able to create the service, but you will encounter unexpected problems.</li>
</ul>

<h2 id="interacting-with-your-foldered-service">Interacting with your foldered service</h2>

<ul>
  <li>Interact with your foldered service via the DC/OS CLI with this flag: <code class="highlighter-rouge">--name=/path/to/myservice</code>.</li>
  <li>To interact with your foldered service over the web directly, use <code class="highlighter-rouge">http://&lt;dcos-url&gt;/service/path/to/myservice</code>. E.g., <code class="highlighter-rouge">http://&lt;dcos-url&gt;/service/testing/elastic/v1/endpoints</code>.</li>
</ul>

<h2 id="placement-constraints">Placement Constraints</h2>

<p>Placement constraints allow you to customize where a service is deployed in the DC/OS cluster. Depending on the service, some or all components may be configurable using <a href="http://mesosphere.github.io/marathon/docs/constraints.html">Marathon operators (reference)</a>. For example, <code class="highlighter-rouge">[["hostname", "UNIQUE"]]</code> ensures that at most one pod instance is deployed per agent.</p>

<p>A common task is to specify a list of whitelisted systems to deploy to. To achieve this, use the following syntax for the placement constraint:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[["hostname", "LIKE", "10.0.0.159|10.0.1.202|10.0.3.3"]]
</code></pre></div></div>

<p>You must include spare capacity in this list, so that if one of the whitelisted systems goes down, there is still enough room to repair your service (via <a href="#replace-a-pod"><code class="highlighter-rouge">pod replace</code></a>) without requiring that system.</p>

<h2 id="regions-and-zones">Regions and Zones</h2>

<p>Placement constraints can be applied to zones by referring to the <code class="highlighter-rouge">@zone</code> key. For example, one could spread pods across a minimum of 3 different zones by specifying the constraint:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[["@zone", "GROUP_BY", "3"]]
</code></pre></div></div>

<p>When the region awareness feature is enabled (currently in beta), the <code class="highlighter-rouge">@region</code> key can also be referenced for defining placement constraints. Any placement constraints that do not reference the <code class="highlighter-rouge">@region</code> key are constrained to the local region.</p>

<h3 id="example">Example</h3>

<p>Suppose we have a Mesos cluster with zones <code class="highlighter-rouge">a</code>,<code class="highlighter-rouge">b</code>,<code class="highlighter-rouge">c</code>. For balanced Placement for a Single Region:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  ...
  "count": 6,
  "placement": "[[\"@zone\", \"GROUP_BY\", \"3\"]]"
}
</code></pre></div></div>

<p>Instances will all be evenly divided between zones <code class="highlighter-rouge">a</code>,<code class="highlighter-rouge">b</code>,<code class="highlighter-rouge">c</code>.</p>

<h1 id="custom-installation">Custom Installation</h1>

<p>You can customize the Elastic cluster in a variety of ways by specifying a JSON options file. For example, here is a sample JSON options file that customizes the service name, master transport port, and plugins:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"another-cluster"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"master_nodes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"transport_port"</span><span class="p">:</span><span class="w"> </span><span class="mi">19300</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"elasticsearch"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"plugins"</span><span class="p">:</span><span class="w"> </span><span class="s2">"analysis-icu,analysis-kuromoji"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The command below creates a cluster using a <code class="highlighter-rouge">options.json</code> file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos package <span class="nb">install </span>beta-elastic <span class="nt">--options</span><span class="o">=</span>options.json
</code></pre></div></div>

<p><strong>Recommendation:</strong> Store your custom configuration in source control.</p>

<h1 id="multiple-elastic-cluster-installation">Multiple Elastic Cluster Installation</h1>

<p>Installing multiple Elastic clusters is identical to installing Elastic clusters with custom configurations as described above. The only requirement on the operator is that a unique <code class="highlighter-rouge">name</code> is specified for each installation.</p>

<p>Sample JSON options file named <code class="highlighter-rouge">another-cluster.json</code>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"another-cluster"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The command below creates a cluster using <code class="highlighter-rouge">another-cluster.json</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos package <span class="nb">install </span>beta-elastic <span class="nt">--options</span><span class="o">=</span>another-cluster.json
</code></pre></div></div>

<p>See the Configuring section for a list of fields that can be customized via an options JSON file when the Elastic cluster is created.</p>

<h2 id="virtual-networks">Virtual networks</h2>

<p>Elastic supports deployment on virtual networks on DC/OS (including the <code class="highlighter-rouge">dcos</code> overlay network), allowing each container (task) to have its own IP address and not use the ports resources on the agent. This can be specified by passing the following configuration during installation:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"virtual_network_enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>As mentioned in the <a href="https://mesosphere.github.io/dcos-commons/developer-guide.html">developer guide</a> once the service is deployed on a virtual network, it cannot be updated to use the host network.</p>

<h2 id="tls">TLS</h2>

<p>The Elastic service can be launched with TLS encryption. Enabling TLS will switch all internal communication between Elastic nodes to encrypted connections.</p>

<p>Enabling TLS is only possible in <code class="highlighter-rouge">permissive</code> and <code class="highlighter-rouge">strict</code> cluster security modes on Enterprise DC/OS. Both modes require a service account. Additionally, a service account must have the <code class="highlighter-rouge">dcos:superuser</code> permission. If the permission is missing the Elastic scheduler will not abe able to provision TLS artifacts.</p>

<p>Installing Elastic with TLS support requires <a href="../elastic-x-pack/">enabling X-Pack functionality</a>.</p>

<p>Sample JSON options file named <code class="highlighter-rouge">elastic-tls.json</code>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"service_account_secret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"elastic"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"service_account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"elastic"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"security"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"transport_encryption"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"elasticsearch"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"xpack_enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>For more information about TLS in the SDK see <a href="https://mesosphere.github.io/dcos-commons/developer-guide.html#tls">the TLS documentation</a>.</p>

<h3 id="clients">Clients</h3>

<p>Clients connecting to the Elastic service are required to use <a href="https://docs.mesosphere.com/1.10/networking/tls-ssl/get-cert/">the DC/OS CA bundle</a> to verify the TLS connections.</p>

<h3 id="kibana">Kibana</h3>

<p>When the Elastic service is deployed on DC/OS with TLS support Kibana, acting as an Elastic client, must be configured to verify TLS with the DC/OS CA bundle. To install the DC/OS CA bundle launch Kibana with the following configuration.</p>

<p>Sample JSON options file named <code class="highlighter-rouge">kibana-tls.json</code>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"kibana"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"xpack_enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"elasticsearch_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://coordinator.elastic.l4lb.thisdcos.directory:9200"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"elasticsearch_tls"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Similarly to Elastic, Kibana requires <a href="../elastic-x-pack/">X-Pack</a> to be installed. The Kibana package itself doesn’t support exposing itself over a TLS connection.</p>

<h1 id="changing-configuration-at-runtime">Changing Configuration at Runtime</h1>

<!-- THIS CONTENT DUPLICATES THE DC/OS OPERATION GUIDE -->

<p>The instructions below describe how to update the configuration for a running DC/OS service.</p>

<h2 id="enterprise-dcos-110">Enterprise DC/OS 1.10</h2>

<p>Enterprise DC/OS 1.10 introduces a convenient command line option that allows for easier updates to a service’s configuration, as well as allowing users to inspect the status of an update, to pause and resume updates, and to restart or complete steps if necessary.</p>

<h3 id="prerequisites-1">Prerequisites</h3>

<ul>
  <li>Enterprise DC/OS 1.10 or newer.</li>
  <li>Service with a version greater than 2.0.0-x.</li>
  <li><a href="https://docs.mesosphere.com/latest/cli/install/">The DC/OS CLI</a> installed and available.</li>
  <li>The service’s subcommand available and installed on your local machine.
    <ul>
      <li>You can install just the subcommand CLI by running <code class="highlighter-rouge">dcos package install --cli beta-elastic</code>.</li>
      <li>If you are running an older version of the subcommand CLI that doesn’t have the <code class="highlighter-rouge">update</code> command, uninstall and reinstall your CLI.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dcos package uninstall <span class="nt">--cli</span> beta-elastic
dcos package <span class="nb">install</span> <span class="nt">--cli</span> beta-elastic
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="preparing-configuration">Preparing configuration</h3>

<p>If you installed this service with Enterprise DC/OS 1.10, you can fetch the full configuration of a service (including any default values that were applied during installation). For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos beta-elastic <span class="nt">--name</span><span class="o">=</span>elastic describe <span class="o">&gt;</span> options.json
</code></pre></div></div>

<p>Make any configuration changes to this <code class="highlighter-rouge">options.json</code> file.</p>

<p>If you installed this service with a prior version of DC/OS, this configuration will not have been persisted by the the DC/OS package manager. You can instead use the <code class="highlighter-rouge">options.json</code> file that was used when <a href="#initial-service-configuration">installing the service</a>.</p>

<p><strong>Note:</strong> You must specify all configuration values in the <code class="highlighter-rouge">options.json</code> file when performing a configuration update. Any unspecified values will be reverted to the default values specified by the DC/OS service. See the “Recreating <code class="highlighter-rouge">options.json</code>” section below for information on recovering these values.</p>

<h4 id="recreating-optionsjson-optional">Recreating <code class="highlighter-rouge">options.json</code> (optional)</h4>

<p>If the <code class="highlighter-rouge">options.json</code> from when the service was last installed or updated is not available, you will need to manually recreate it using the following steps.</p>

<p>First, we’ll fetch the default application’s environment, current application’s environment, and the actual template that maps config values to the environment:</p>

<ol>
  <li>Ensure you have <a href="https://stedolan.github.io/jq/">jq</a> installed.</li>
  <li>Set the service name that you’re using, for example:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ SERVICE_NAME</span><span class="o">=</span>elastic
</code></pre></div>    </div>
  </li>
  <li>Get the version of the package that is currently installed:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ PACKAGE_VERSION</span><span class="o">=</span><span class="k">$(</span>dcos package list | <span class="nb">grep</span> <span class="nv">$SERVICE_NAME</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="k">)</span>
</code></pre></div>    </div>
  </li>
  <li>Then fetch and save the environment variables that have been set for the service:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos marathon app show <span class="nv">$SERVICE_NAME</span> | jq .env <span class="o">&gt;</span> current_env.json
</code></pre></div>    </div>
  </li>
  <li>To identify those values that are custom, we’ll get the default environment variables for this version of the service:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos package describe <span class="nt">--package-version</span><span class="o">=</span><span class="nv">$PACKAGE_VERSION</span> <span class="nt">--render</span> <span class="nt">--app</span> <span class="nv">$SERVICE_NAME</span> | jq .env <span class="o">&gt;</span> default_env.json
</code></pre></div>    </div>
  </li>
  <li>We’ll also get the entire application template:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos package describe <span class="nv">$SERVICE_NAME</span> <span class="nt">--app</span> <span class="o">&gt;</span> marathon.json.mustache
</code></pre></div>    </div>
  </li>
</ol>

<p>Now that you have these files, we’ll attempt to recreate the <code class="highlighter-rouge">options.json</code>.</p>

<ol>
  <li>Use JQ and <code class="highlighter-rouge">diff</code> to compare the two:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>diff &lt;<span class="o">(</span>jq <span class="nt">-S</span> <span class="nb">.</span> default_env.json<span class="o">)</span> &lt;<span class="o">(</span>jq <span class="nt">-S</span> <span class="nb">.</span> current_env.json<span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>Now compare these values to the values contained in the <code class="highlighter-rouge">env</code> section in application template:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>less marathon.json.mustache
</code></pre></div>    </div>
  </li>
  <li>Use the variable names (e.g. <code class="highlighter-rouge">service.name</code>) to create a new <code class="highlighter-rouge">options.json</code> file as described in <a href="#initial-service-configuration">Initial service configuration</a>.</li>
</ol>

<h3 id="starting-the-update">Starting the update</h3>

<p>Once you are ready to begin, initiate an update using the DC/OS CLI, passing in the updated <code class="highlighter-rouge">options.json</code> file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos beta-elastic <span class="nt">--name</span><span class="o">=</span>elastic update start <span class="nt">--options</span><span class="o">=</span>options.json
</code></pre></div></div>

<p>You will receive an acknowledgement message and the DC/OS package manager will restart the Scheduler in Marathon.</p>

<p>See <a href="#advanced-update-actions">Advanced update actions</a> for commands you can use to inspect and manipulate an update after it has started.</p>

<h3 id="open-source-dcos-enterprise-dcos-19-and-earlier">Open Source DC/OS, Enterprise DC/OS 1.9 and earlier</h3>

<p>If you do not have Enterprise DC/OS 1.10 or later, the CLI commands above are not available. For Open Source DC/OS of any version, or Enterprise DC/OS 1.9 and earlier, you can perform changes from the DC/OS GUI.</p>

<!-- END DUPLICATE BLOCK -->

<p>These are the general steps to follow:</p>

<ol>
  <li>View your DC/OS dashboard at <code class="highlighter-rouge">http://$DCOS_URI/#/services/overview</code></li>
  <li>In the list of <code class="highlighter-rouge">Applications</code>, click the name of the Elastic service to be updated.</li>
  <li>Within the Elastic instance details view, click the <code class="highlighter-rouge">Configuration</code> tab, then click <code class="highlighter-rouge">Edit</code>.</li>
  <li>In the dialog that appears, expand the <code class="highlighter-rouge">Environment Variables</code> section and update any field(s) to their desired value(s). For example, to increase the number of data nodes, edit the value for <code class="highlighter-rouge">DATA_NODE_COUNT</code>. Do not edit the value for <code class="highlighter-rouge">FRAMEWORK_NAME</code>, <code class="highlighter-rouge">MASTER_NODE_TRANSPORT_PORT</code>, or any of the disk type/size fields.</li>
  <li>Click <code class="highlighter-rouge">Change and deploy configuration</code> to apply any changes and cleanly reload the Elastic service scheduler. The Elastic cluster itself will persist across the change.</li>
</ol>

<h1 id="configuration-guidelines">Configuration Guidelines</h1>

<ul>
  <li>Service name: This needs to be unique for each instance of the service that is running. It is also used as your cluster name.</li>
  <li>Service user: This must be a non-root user that already exists on each agent. The default user is <code class="highlighter-rouge">nobody</code>.</li>
  <li>X-Pack is not installed by default, but you can enable it. X-Pack comes with a 30-day trial license.</li>
  <li>Health check credentials: If you have X-Pack enabled, the health check will use these credentials for authorization. We recommend you create a specific Elastic user/password for this with minimal capabilities rather than using the default superuser <code class="highlighter-rouge">elastic</code>.</li>
  <li>Plugins: You can specify other plugins via a comma-separated list of plugin names (e.g., “analysis-icu”) or plugin URIs.</li>
  <li>CPU/RAM/Disk/Heap: These will be specific to your DC/OS cluster and your Elasticsearch use cases. Please refer to Elastic’s guidelines for configuration.</li>
  <li>Node counts: At least 1 data node is required for the cluster to operate at all. You do not need to use a coordinator node. Learn about Elasticsearch node types <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html">here</a>. There is no maximum for node counts.</li>
  <li>Master transport port: You can pick whichever port works for your DC/OS cluster. The default is 9300. If you want multiple master nodes from different clusters on the same host, specify different master HTTP and transport ports for each cluster. If you want to ensure a particular distribution of nodes of one task type (e.g., master nodes spread across 3 racks, data nodes on one class of machines), specify this via the Marathon placement constraint.</li>
  <li>Serial vs Parallel deployment. By default, the DC/OS Elastic Service tells DC/OS to install everything in parallel. You can change this to serial in order to have each node installed one at a time.</li>
  <li>Serial vs Parallel update. By default, the DC/OS Elastic Service tells DC/OS to update everything serially. You can change this to parallel in order to have each node updated at the same time. This is required, for instance, when you turn X-Pack on or off.</li>
  <li>Custom YAML can be appended to <code class="highlighter-rouge">elasticsearch.yml</code> on each node</li>
</ul>

<h2 id="immutable-settings-at-cluster-creation-time-via-elastic-package-ui-or-json-options-file-via-cli">Immutable settings (at cluster creation time via Elastic package UI or JSON options file via CLI)</h2>

<p>These setting cannot be changed after installation.</p>

<ul>
  <li>Service name (aka cluster name). Can be hyphenated, but not underscored.</li>
  <li>Master transport port.</li>
  <li>Disk sizes/types.</li>
</ul>

<h2 id="modifiable-settings-at-runtime-via-marathon-env-vars">Modifiable settings (at runtime via Marathon env vars):</h2>

<ul>
  <li>Plugins</li>
  <li>CPU</li>
  <li>Memory</li>
  <li>JVM Heap (do not exceed ½ available node RAM)</li>
  <li>Node count (up, not down)</li>
  <li>Health check credentials</li>
  <li>X-Pack enabled/disabled</li>
  <li>Deployment/Upgrade strategy (serial/parallel). Note that serial deployment does not yet wait for the cluster to reach green before proceeding to the next node. This is a known limitation.</li>
  <li>Custom <code class="highlighter-rouge">elasticsearch.yml</code></li>
</ul>

<p>Any other modifiable settings are covered by the various Elasticsearch APIs (cluster settings, index settings, templates, aliases, scripts). It’s possible that some of the more common cluster settings will get exposed in future versions of the Elastic DC/OS Service.</p>

<h1 id="viewing-plans-via-the-cli">Viewing Plans via the CLI</h1>

<p>You can view the deploy plan for the DC/OS Elastic Service via the service URL: <code class="highlighter-rouge">http://$DCOS_URL/service/$SERVICE_NAME/v1/plans</code></p>

<h1 id="topology">Topology</h1>

<p>Each task in the cluster performs one and only one of the following roles: master, data, ingest, coordinator.</p>

<p>The default placement strategy specifies no constraint except that all the master nodes are distributed to different agents. You can specify further <a href="http://mesosphere.github.io/marathon/docs/constraints.html">Marathon placement constraints</a> for each node type. For example, you can specify that data nodes are never colocated, or that ingest nodes are deployed on a rack with high-CPU servers.</p>

<p><img src="../img/private-nodes-by-agent.png" alt="agent" />
<img src="../img/private-node-by-vip.png" alt="vip" /></p>

<p>No matter how big or small the cluster is, there will always be exactly 3 master-only nodes with <code class="highlighter-rouge">minimum_master_nodes = 2</code>.</p>

<h2 id="default-topology-with-minimum-resources-to-run-on-3-agents">Default Topology (with minimum resources to run on 3 agents)</h2>

<ul>
  <li>3 master-only nodes</li>
  <li>2 data-only nodes</li>
  <li>1 coordinator-only node</li>
  <li>0 ingest-only node</li>
</ul>

<p>The master/data/ingest/coordinator nodes are set up to only perform their one role. That is, master nodes do not store data, and ingest nodes do not store cluster state.</p>

<h2 id="minimal-topology">Minimal Topology</h2>

<p>You can set up a minimal development/staging cluster without ingest nodes, or coordinator nodes. You’ll still get 3 master nodes placed on 3 separate hosts. If you don’t care about replication, you can even use just 1 data node. By default, Elasticsearch creates indices with a replication factor of 1 (i.e., 1 primary shard + 1 replica), so with 1 data node, your cluster will be stuck in a ‘yellow’ state unless you change the replication factor.</p>

<p>Note that with X-Pack installed, the default monitoring behavior is to try to write to an ingest node every few seconds. Without an ingest node, you will see frequent warnings in your master node error logs. While they can be ignored, you can turn them off by disabling X-Pack monitoring in your cluster, like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-XPUT</span> <span class="nt">-u</span> elastic:changeme master.elastic.l4lb.thisdcos.directory:9200/_cluster/settings <span class="nt">-d</span> <span class="s1">'{
    "persistent" : {
        "xpack.monitoring.collection.interval" : -1
    }
}'</span>
</code></pre></div></div>

</div>
</div>
</body>

</html>
