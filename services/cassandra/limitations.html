<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">







<head>
<title>Cassandra: Limitations</title>
<link rel="stylesheet" type="text/css" media="all" href="../../style/gh-basic.css" />
<link rel="shortcut icon" type="image/png" href="https://mesosphere.com/favicon.ico"/>
<!-- The Dropdown library is written by Stephen Morley, licensed CC0 1.0 Universal (Public Domain Dedication)-->
<link rel="stylesheet" type="text/css" media="all" href="../../style/Dropdown.css" />
<script src="../../style/Dropdown.js"></script>
<style type="text/css">
/* set the background color of menu items */
.dropdown, .dropdown ul { background: #555555; clear: both; }
/* set the background color of active items */
.dropdown li:hover > a, .dropdown li:hover > span, .dropdown li.dropdownOpen > a, .dropdown li.dropdownOpen > span { background: #af87e0; }
/* pad items, set their text color, and fade their background color */
.dropdown a, .dropdown span { padding: 0.25em 0.5em; color: white; transition: background 0.2s; }
/* show '+' on expandable items */
.dropdown span:after { content: " +"; }

/* toc style: remove extra margin between elements */
#markdown-toc ul { margin: 0; }
</style>
</head>

<body>
<div id="wrapper">

<a href="../..">
<img style="float: left; margin-bottom: 2em" src="https://mesosphere.com/wp-content/themes/mesosphere/library/images/assets/dcos-sdk-logo.png" width="250" alt="DC/OS Software Development Kit" />
</a>
<img style="float: right" src="https://img.shields.io/badge/Status-Alpha-BF97F0.svg?style=flat-square" alt="Status: Alpha" />

<ul class="dropdown" style="clear: both">
  <li>
    <a href="../..">Home</a>
  </li>
  <li>
    <span>Documentation</span>
    <ul>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li><a href="../../developer-guide.html">SDK Developer Guide</a></li>
      
      
      
      <li><a href="../../operations-guide.html">SDK Operations Guide</a></li>
      
      
      
      <li><a href="../../faq.html">Frequently Asked Questions</a></li>
      
      
      
      <li><a href="../../glossary.html">Glossary</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </li>
  <li>
    <span>Tutorials</span>
    <ul>
      
      
      
      <li><a href="../../tutorials/automatic-repair.html">Automatic Repair</a></li>
      
      <li><a href="../../tutorials/kafka-tutorial.html">Kafka Tutorial</a></li>
      
      <li><a href="../../tutorials/quick-start-java.html">Quick Start (Java)</a></li>
      
    </ul>
  </li>
  <li>
    <span>Reference</span>
    <ul>
      
      <li><a href="../../reference/api">Javadoc Reference</a></li>
      <li><a href="../../reference/swagger-api">REST APIs</a></li>
      <li><a href="../../reference/yaml-reference.html">YAML Reference</a></li>
    </ul>
  </li>
  <li>
    <span>Services</span>
    <ul>
      
      
      
      
      <li>
        
        <span>Elastic</span>
        
        <ul>
          
          
          <li><a href="../../services/elastic/install.html">Install and Customize</a></li>
          
          <li><a href="../../services/elastic/quick-start.html">Usage Example</a></li>
          
          <li><a href="../../services/elastic/upgrade.html">Upgrade</a></li>
          
          <li><a href="../../services/elastic/uninstall.html">Uninstall</a></li>
          
          <li><a href="../../services/elastic/configure.html">Configuring</a></li>
          
          <li><a href="../../services/elastic/x-pack.html">X-Pack</a></li>
          
          <li><a href="../../services/elastic/connecting.html">Connecting Clients</a></li>
          
          <li><a href="../../services/elastic/backup_restore.html">Backup and Restore</a></li>
          
          <li><a href="../../services/elastic/managing.html">Managing</a></li>
          
          <li><a href="../../services/elastic/api-reference.html">API Reference</a></li>
          
          <li><a href="../../services/elastic/troubleshooting.html">Troubleshooting</a></li>
          
          <li><a href="../../services/elastic/version_policy.html">Version Policy</a></li>
          
          <li><a href="../../services/elastic/limitations.html">Limitations</a></li>
          
          <li><a href="../../services/elastic/changelog.html">Changelog</a></li>
          
        </ul>
      </li>
      
      <li>
        
        <span>HDFS</span>
        
        <ul>
          
          
          <li><a href="../../services/hdfs/quick-start.html">Quickstart</a></li>
          
          <li><a href="../../services/hdfs/install.html">Install and Customize</a></li>
          
          <li><a href="../../services/hdfs/uninstall.html">Uninstall</a></li>
          
          <li><a href="../../services/hdfs/configure.html">Configuring</a></li>
          
          <li><a href="../../services/hdfs/connecting-clients.html">Connecting Clients</a></li>
          
          <li><a href="../../services/hdfs/limitations.html">Limitations</a></li>
          
          <li><a href="../../services/hdfs/managing.html">Managing</a></li>
          
          <li><a href="../../services/hdfs/api-reference.html">API Reference</a></li>
          
          <li><a href="../../services/hdfs/troubleshooting.html">Troubleshooting</a></li>
          
        </ul>
      </li>
      
      <li>
        
        <span>Kafka</span>
        
        <ul>
          
          
          <li><a href="../../services/kafka/install-and-customize.html">Install and Customize</a></li>
          
          <li><a href="../../services/kafka/quick-start.html">Quick Start</a></li>
          
          <li><a href="../../services/kafka/uninstall.html">Uninstall</a></li>
          
          <li><a href="../../services/kafka/configure.html">Configure</a></li>
          
          <li><a href="../../services/kafka/connecting-clients.html">Connecting Clients</a></li>
          
          <li><a href="../../services/kafka/managing.html">Managing</a></li>
          
          <li><a href="../../services/kafka/api-reference.html">API Reference</a></li>
          
          <li><a href="../../services/kafka/troubleshooting.html">Troubleshooting</a></li>
          
          <li><a href="../../services/kafka/version-policy.html">Version Policy</a></li>
          
          <li><a href="../../services/kafka/limitations.html">Limitations</a></li>
          
        </ul>
      </li>
      
    </ul>
  </li>
  <li><a href="https://github.com/mesosphere/dcos-commons/blob/master/CONTRIBUTING.md">Contributing</a></li>
  <li><a href="http://chat.dcos.io" target="_blank">Slack</a></li>
</ul>
<h1>Cassandra: Limitations</h1>
<div id="content">
<ul>
  <li>Data Center Name</li>
</ul>

<p>Data Center Name:</p>

<p>The name of the data center cannot be changed after Cassandra installation. <code class="highlighter-rouge">service.data_center</code> and <code class="highlighter-rouge">service.rack</code> options are not allowed to be modified once Cassandra is installed.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>"service": {
……
      data_center": {
          "description": "The name of the data center this cluster is running in",
          "type": "string",
          "default": "datacenter1"
        },
        "rack": {
          "description": "The name of the rack this cluster is running on",
          "type": "string",
          "default": "rack1"
        },
……
}
</code></pre>
</div>

<ul>
  <li>Seed Node Replace</li>
</ul>

<p>While the Cassandra service supports a node replace operation via the command
<code class="highlighter-rouge">dcos cassandra pod replace ≤node_id≥</code>, the node replace operation performs a
<code class="highlighter-rouge">replace_address</code>, which is sufficient for non-seed nodes, but is insufficient
with regard to a seed node.</p>

<p>For more information and a comparable procedure for “Replacing a dead node or
dead seed node” from DataStax, see the following:
http://docs.datastax.com/en/cassandra/3.0/cassandra/operations/opsReplaceNode.html</p>

<p>The following script automates the DC/OS Cassandra service seed node replace
procedure and will be used to explain the equivalent manual procedure:</p>

<!--- snip{ dcos_cassandra_seed_node_replace.sh -->
<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="c"># DC/OS Cassandra (C*) seed node restart script.</span>
<span class="c">#</span>
<span class="c"># This script helps automate the restart (or not) of non-seed nodes following</span>
<span class="c"># a seed node restart. Restarting non-seed nodes is necessary as C* internally</span>
<span class="c"># uses the resolved ip address for the seed node.</span>
<span class="c">#</span>
<span class="c"># Tested for the following DC/OS versions:</span>
<span class="c"># - 1.10</span>

cassandra_cli_install <span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> ! dcos cassandra --help &gt;/dev/null 2&gt;&amp;1; <span class="k">then
        </span>dcos package install cassandra --cli
    <span class="k">fi</span>
<span class="o">}</span>

cassandra_nodes_list <span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">"</span><span class="nv">$CASSANDRA_NODES</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">then
        </span><span class="nv">CASSANDRA_NODES</span><span class="o">=</span><span class="k">$(</span>dcos cassandra pod list <span class="se">\</span>
            | jq <span class="s1">'map(.) | join(" ")'</span> <span class="se">\</span>
            | sed <span class="s1">'s/\"//g'</span><span class="k">)</span>
    <span class="k">fi
    </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$CASSANDRA_NODES</span><span class="s2">"</span>
<span class="o">}</span>

cassandra_nodes_seed_get <span class="o">()</span> <span class="o">{</span>
    <span class="nv">nodes</span><span class="o">=</span><span class="k">$(</span>cassandra_nodes_list<span class="k">)</span>
    <span class="k">for </span>node <span class="k">in</span> <span class="nv">$nodes</span>; <span class="k">do
        </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$node</span><span class="s2">"</span>
        <span class="k">return
    done</span>
<span class="o">}</span>

cassandra_nodes_node_ip_get <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    dcos cassandra pod info <span class="nv">$node</span> <span class="se">\</span>
        |awk <span class="s1">'/\"ipAddress\":/{i=$2; gsub("\"", "", i); gsub(",", "", i); print i}'</span>
<span class="o">}</span>

cassandra_nodes_node_taskstate_get <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    dcos cassandra pod status <span class="nv">$node</span> <span class="se">\</span>
        |awk <span class="s1">'/\"state\":.*\"TASK_/ { print }'</span> <span class="se">\</span>
        |awk -F<span class="s1">':'</span> <span class="s1">'{s=$2; gsub("\"", "", s); gsub(/^ /, "", s); gsub(/ $/, "", s); print s}'</span>
<span class="o">}</span>

cassandra_nodes_node_wait_for_taskstate <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">task_state</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">retry_delay</span><span class="o">=</span>1
    <span class="nv">max_wait</span><span class="o">=</span>60
    <span class="nv">wait_remaining</span><span class="o">=</span><span class="nv">$max_wait</span>
    <span class="k">while</span> <span class="o">[</span> <span class="s2">"x</span><span class="k">$(</span>cassandra_nodes_node_taskstate_get <span class="nv">$node</span><span class="k">)</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"x</span><span class="nv">$task_state</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">do
        </span><span class="nb">echo</span> <span class="s2">"waiting for </span><span class="nv">$node</span><span class="s2"> to enter </span><span class="nv">$task_state</span><span class="s2"> state"</span>
        sleep <span class="nv">$retry_delay</span>
        <span class="nv">wait_remaining</span><span class="o">=</span><span class="k">$((</span>wait_remaining <span class="o">-</span> <span class="m">1</span><span class="k">))</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$wait_remaining</span> -lt 0 <span class="o">]</span>; <span class="k">then
            </span><span class="nb">echo</span> <span class="s2">"Breaking out of wait for </span><span class="nv">$node</span><span class="s2"> to reach </span><span class="nv">$task_state</span><span class="s2">, errors may abound..."</span>
            <span class="nb">break
        </span><span class="k">fi
    done</span>
<span class="o">}</span>

cassandra_nodes_node_restart <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    dcos cassandra pod restart <span class="nv">$node</span>
<span class="o">}</span>

cassandra_nodes_node_replace <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    dcos cassandra pod replace <span class="nv">$node</span>
<span class="o">}</span>

cassandra_nodes_node_taskid_get <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    dcos task |awk <span class="s2">"/</span><span class="k">${</span><span class="nv">node</span><span class="k">}</span><span class="s2">-server/ { print </span><span class="se">\$</span><span class="s2">5}"</span>
<span class="o">}</span>

cassandra_nodes_node_nodetool_ <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">nodetool_subcommand</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">shift </span>2
    <span class="nv">nodetool_args</span><span class="o">=</span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>

    <span class="nv">java_dir</span><span class="o">=</span><span class="k">$(</span>dcos task <span class="nb">exec</span> <span class="nv">$node</span> bash -c <span class="s1">'echo $PWD/$(ls -d jre* |tail -n 1)'</span> |grep -v <span class="s1">'Overwriting environment'</span><span class="k">)</span>
    <span class="nv">cassandra_dir</span><span class="o">=</span><span class="k">$(</span>dcos task <span class="nb">exec</span> <span class="nv">$node</span> bash -c <span class="s1">'echo $PWD/$(ls -d apache-cassandra-* |head -n 1)'</span> |grep -v <span class="s1">'Overwriting environment'</span><span class="k">)</span>
    <span class="nv">cassandra_jmx_port</span><span class="o">=</span>7199

    dcos task <span class="nb">exec</span> <span class="nv">$node</span> bash -c <span class="s2">"export JAVA_HOME=</span><span class="k">${</span><span class="nv">java_dir</span><span class="k">}</span><span class="s2">; </span><span class="k">${</span><span class="nv">cassandra_dir</span><span class="k">}</span><span class="s2">/bin/nodetool -p </span><span class="k">${</span><span class="nv">cassandra_jmx_port</span><span class="k">}</span><span class="s2"> </span><span class="k">${</span><span class="nv">nodetool_subcommand</span><span class="k">}</span><span class="s2"> </span><span class="k">${</span><span class="nv">nodetool_args</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span>

cassandra_nodes_node_nodetool_remove_by_dcosid <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">node_to_remove</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">node_ip</span><span class="o">=</span><span class="k">$(</span>dcos task |grep <span class="k">${</span><span class="nv">node_to_remove</span><span class="k">}</span>|awk <span class="s1">'{print $2}'</span><span class="k">)</span>
    <span class="nv">cassandra_id</span><span class="o">=</span><span class="k">$(</span>cassandra_nodes_node_nodetool_ <span class="k">${</span><span class="nv">node</span><span class="k">}</span> status |awk <span class="s2">"/</span><span class="k">${</span><span class="nv">node_ip</span><span class="k">}</span><span class="s2">/ {print </span><span class="se">\$</span><span class="s2">7}"</span><span class="k">)</span>
    cassandra_nodes_node_nodetool_ <span class="k">${</span><span class="nv">node</span><span class="k">}</span> removenode <span class="k">${</span><span class="nv">cassandra_id</span><span class="k">}</span>
<span class="o">}</span>

cassandra_nodes_seed_restart <span class="o">()</span> <span class="o">{</span>
    <span class="nv">seed_node</span><span class="o">=</span><span class="k">$(</span>cassandra_nodes_seed_get<span class="k">)</span>
    <span class="nb">echo</span> <span class="s2">"got seed_node: </span><span class="nv">$seed_node</span><span class="s2">"</span>
    <span class="nv">seed_ip_pre</span><span class="o">=</span><span class="k">$(</span>cassandra_nodes_node_ip_get <span class="nv">$seed_node</span><span class="k">)</span>
    <span class="nb">echo</span> <span class="s2">"seed_ip_pre: </span><span class="nv">$seed_ip_pre</span><span class="s2">"</span>
    cassandra_nodes_node_replace <span class="nv">$seed_node</span>
    <span class="nb">echo</span> <span class="s2">"restarted seed node, zzz a sec"</span>
    cassandra_nodes_node_wait_for_taskstate <span class="nv">$seed_node</span> <span class="s1">'TASK_STAGING'</span>
    cassandra_nodes_node_wait_for_taskstate <span class="nv">$seed_node</span> <span class="s1">'TASK_RUNNING'</span>
    <span class="nv">seed_ip_post</span><span class="o">=</span><span class="k">$(</span>cassandra_nodes_node_ip_get <span class="nv">$seed_node</span><span class="k">)</span>
    <span class="nb">echo</span> <span class="s2">"seed_ip_post: </span><span class="nv">$seed_ip_post</span><span class="s2">"</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"x</span><span class="nv">$seed_ip_pre</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"x</span><span class="nv">$seed_ip_post</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"the seed node ip did not change, so no need to restart the other nodes"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"the seed node ip changed, so A) removing the node and B) performing a rolling restart of the other nodes"</span>
        <span class="k">for </span>node <span class="k">in</span> <span class="k">$(</span>cassandra_nodes_list<span class="k">)</span>; <span class="k">do
            if</span> <span class="o">[</span> <span class="s2">"x</span><span class="nv">$node</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"x</span><span class="nv">$seed_node</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">then
                </span><span class="nv">non_seed_node</span><span class="o">=</span><span class="nv">$node</span>
                <span class="nb">break
            </span><span class="k">fi
        done

        for </span>node <span class="k">in</span> <span class="k">$(</span>cassandra_nodes_list<span class="k">)</span>; <span class="k">do
            if</span> <span class="o">[</span> <span class="s2">"x</span><span class="nv">$node</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"x</span><span class="nv">$seed_node</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">then
                </span>cassandra_nodes_node_nodetool_remove_by_dcosid <span class="nv">$non_seed_node</span> <span class="nv">$seed_node</span>
            <span class="k">else
                </span>cassandra_nodes_node_restart <span class="nv">$node</span>
                sleep 1
                cassandra_nodes_node_wait_for_taskstate <span class="nv">$node</span> <span class="s1">'TASK_STAGING'</span>
                cassandra_nodes_node_wait_for_taskstate <span class="nv">$node</span> <span class="s1">'TASK_RUNNING'</span>
            <span class="k">fi
        done
    fi

    </span><span class="nb">echo</span> <span class="s2">"if all went well, there should be only up nodes (UN in first field) in the following:"</span>
    cassandra_nodes_node_nodetool_ <span class="nv">$seed_node</span> status
<span class="o">}</span>

main <span class="o">()</span> <span class="o">{</span>
    cassandra_nodes_seed_restart
<span class="o">}</span>
main
</code></pre>
</div>
<!--- snip} script dcos_cassandra_seed_node_replace.sh -->

<p>The corresponding manual procedure requires several facts to be repeatedly
used/applied. To this end, environment variables will be used. The shell
commands scattered throughout the manual procedure are assumed to be executed
within a single environment/context.</p>

<p>The corresponding manual procedure follows:</p>

<ol>
  <li>Take note of the seed node’s id (SEED_NODE) and ip (SEED_IP) by issuing the
following commands:</li>
</ol>

<p>1.a.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nv">SEED_NODE</span><span class="o">=</span><span class="k">$(</span> <span class="se">\</span>
dcos cassandra pod list <span class="se">\</span>
    |jq <span class="s1">'map(.) |join(" ")'</span> |awk <span class="s1">'{gsub("\"", "", $1); print $1}'</span> <span class="se">\</span>
<span class="k">)</span>

1.b.

<span class="nv">SEED_IP</span><span class="o">=</span><span class="k">$(</span> <span class="se">\</span>
dcos cassandra pod info <span class="nv">$SEED_NODE</span> <span class="se">\</span>
    |awk <span class="s1">'/\"ipAddress\":/{i=$2; gsub("\"", "", i); gsub(",", "", i); print i}'</span>
<span class="k">)</span>
</code></pre>
</div>

<ol>
  <li>In order to replace a seed node, issue the following command:</li>
</ol>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>dcos cassandra pod replace <span class="nv">$SEED_NODE</span>
</code></pre>
</div>

<ol>
  <li>Wait until the seed node has been successfully replaced. Watch for the task
with an id starting with ‘node-0’ to progress through “Staging” (TASK_STAGING)
to the “Running” (TASK_RUNNING) state.
3.a. Within the shell, issue the following to wait for the task state for the
seed node:</li>
</ol>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># create a function to generalize obtaining a task state</span>
cassandra_task_state <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    dcos cassandra pod status <span class="k">${</span><span class="nv">node</span><span class="k">}</span> <span class="se">\</span>
        |awk <span class="s1">'/\"state\":.*\"TASK_/ { print }'</span> <span class="se">\</span>
        |awk -F<span class="s1">':'</span> <span class="s1">'{s=$2; gsub("\"", "", s); gsub(/^ /, "", s); gsub(/ $/, "", s); print s}'</span>
<span class="o">}</span>

<span class="c"># create a function to generalize waiting for a task state</span>
cassandra_waitfor_task_state <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">task_state</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nv">retry_delay</span><span class="o">=</span>1 <span class="c">#second(s)</span>
    <span class="nv">max_wait</span><span class="o">=</span>60 <span class="c">#iterations</span>
    <span class="nv">wait_remaining</span><span class="o">=</span><span class="k">${</span><span class="nv">max_wait</span><span class="k">}</span>
    <span class="k">while</span> <span class="o">[</span> <span class="s2">"x</span><span class="k">$(</span>cassandra_task_state <span class="k">${</span><span class="nv">node</span><span class="k">})</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"x</span><span class="k">${</span><span class="nv">task_state</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span>; <span class="k">do
        </span>sleep <span class="k">${</span><span class="nv">retry_delay</span><span class="k">}</span>
        <span class="nv">wait_remaining</span><span class="o">=</span><span class="k">$((</span>wait_remaining <span class="o">-</span> <span class="m">1</span><span class="k">))</span>
        <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">wait_remaining</span><span class="p"> -lt 0 ]; then
            break
        fi
    done
</span><span class="k">}</span>

cassandra_waitfor_task_state <span class="nv">$SEED_NODE</span> TASK_STAGING
cassandra_waitfor_task_state <span class="nv">$SEED_NODE</span> TASK_RUNNING
</code></pre>
</div>

<ol>
  <li>
    <p>After the seed node has been replaced, obtain the new seed node’s ip by
issuing the command in step 1.b.</p>
  </li>
  <li>
    <p>If the seed node’s ip did not change, exit.</p>
  </li>
  <li>
    <p>Since the seed node’s ip changed, notify the underlying Cassandra cluster of
the change.
6.a. Remove the previous seed node from Cassandra’s known cluster state, by
issuing the following commands:</p>
  </li>
</ol>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># create a function to generalize the execution of Cassandra's nodetool (corresponds</span>
<span class="c"># to cassandra_nodes_node_nodetool_ in the full script):</span>

nodetool_ <span class="o">()</span> <span class="o">{</span>
    <span class="nv">node</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nv">nodetool_subcommand</span><span class="o">=</span><span class="nv">$2</span>
    <span class="nb">shift </span>2
    <span class="nv">nodetool_args</span><span class="o">=</span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>

    <span class="c"># local environment variables to make the `dcos task exec ... nodetool ...` easier.</span>
    <span class="nv">java_dir</span><span class="o">=</span><span class="k">$(</span>dcos task <span class="nb">exec</span> <span class="nv">$SEED_NODE</span> bash -c <span class="s1">'echo $PWD/$(ls -d jre* |tail -n 1)'</span> |grep -v <span class="s1">'Overwriting environment'</span><span class="k">)</span>
    <span class="nv">cassandra_dir</span><span class="o">=</span><span class="k">$(</span>dcos task <span class="nb">exec</span> <span class="nv">$SEED_NODE</span> bash -c <span class="s1">'echo $PWD/$(ls -d apache-cassandra-* |head -n 1)'</span> |grep -v <span class="s1">'Overwriting environment'</span><span class="k">)</span>
    <span class="nv">cassandra_jmx_port</span><span class="o">=</span>7199

    dcos task <span class="nb">exec</span> <span class="nv">$SEED_NODE</span> bash -c <span class="s2">"export JAVA_HOME=</span><span class="k">$(</span>java_dir<span class="k">)</span><span class="s2">; </span><span class="k">${</span><span class="nv">cassandra_dir</span><span class="k">}</span><span class="s2">/bin/nodetool -p </span><span class="k">${</span><span class="nv">cassandra_jmx_port</span><span class="k">}</span><span class="s2"> </span><span class="k">${</span><span class="nv">nodetool_subcommand</span><span class="k">}</span><span class="s2"> </span><span class="k">${</span><span class="nv">nodetool_args</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># get the Cassandra id to use in the `nodetool removenode ...` command</span>
<span class="nv">node_ip</span><span class="o">=</span><span class="k">$(</span>dcos task |grep <span class="nv">$SEED_NODE</span> |awk <span class="s1">'{print $2}'</span><span class="k">)</span>
<span class="nv">cassandra_id</span><span class="o">=</span><span class="k">$(</span>nodetool_ <span class="nv">$SEED_NODE</span> status |awk <span class="s2">"/</span><span class="k">${</span><span class="nv">node_ip</span><span class="k">}</span><span class="s2">/ {print </span><span class="se">\$</span><span class="s2">7}"</span><span class="k">)</span>

<span class="c"># remove the old seed node using the new seed node's nodetool</span>
nodetool_ <span class="nv">$SEED_NODE</span> removenode <span class="k">${</span><span class="nv">cassandra_id</span><span class="k">}</span>
</code></pre>
</div>

<p>6.b. Perform a rolling restart of the non-seed nodes in the Cassandra cluster
by issuing the following commands:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="k">for </span>node <span class="k">in</span> <span class="k">$(</span>dcos cassandra pod list <span class="se">\</span>
    |jq <span class="s1">'map(.) |join(" ")'</span> |awk <span class="s1">'{gsub("\"", "", $0); print $0}'</span> <span class="se">\</span>
<span class="k">)</span>; <span class="k">do
    if</span> <span class="o">[</span> <span class="s2">"x</span><span class="k">${</span><span class="nv">node</span><span class="k">}</span><span class="s2"> != "</span>x<span class="nv">$SEED_NODE</span><span class="s2">" ]; then
        dcos cassandra pod restart </span><span class="k">${</span><span class="nv">node</span><span class="k">}</span><span class="s2">
        cassandra_waitfor_task_state </span><span class="nv">$SEED_NODE</span><span class="s2"> TASK_STAGING
        cassandra_waitfor_task_state </span><span class="nv">$SEED_NODE</span><span class="s2"> TASK_RUNNING
    fi
done
</span></code></pre>
</div>

<p>Expected Results:</p>

<ul>
  <li>The Cassandra service is healthy again from a DC/OS perspective, all expected
tasks are in “Running” state.</li>
  <li>The underlying Cassandra view of the cluster hash key ownership is healthy,
all nodes in the DC/OS view are in “Up” state in Cassandra’s <code class="highlighter-rouge">nodetool status</code>.</li>
</ul>

</div>
</div>
</body>

</html>
