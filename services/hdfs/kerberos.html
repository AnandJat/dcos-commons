<h1 id="setting-up-apache-hadoop-distributed-file-system-hdfs-with-kerberos">Setting up Apache Hadoop Distributed File System (HDFS) with Kerberos</h1>

<p>The utility tool <code class="highlighter-rouge">kinit</code> needs to be installed on the agents and be accessible from within the tasksâ€™ containers in order for the system to deploy correctly.</p>

<h2 id="create-principals">Create principals</h2>

<p>In order to run Apache HDFS with Kerberos security enabled, a principal needs to be added for every service component in the cluster. The following principals are required (although the realm can be modified):</p>
<div class="highlighter-rouge"><pre class="highlight"><code>hdfs/name-0-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/name-0-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/name-0-zkfc.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/name-0-zkfc.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/name-1-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/name-1-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/name-1-zkfc.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/name-1-zkfc.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/journal-0-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/journal-0-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/journal-1-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/journal-1-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/journal-2-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/journal-2-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/data-0-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/data-0-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/data-1-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/data-1-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
hdfs/data-2-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/data-2-node.hdfs.autoip.dcos.thisdcos.directory@LOCAL
HTTP/api.hdfs.marathon.l4lb.thisdcos.directory@LOCAL
</code></pre>
</div>
<p>This cluster has 3 data nodes, though the correct number of principals should be added up to N data nodes.
(assuming a default service name of <code class="highlighter-rouge">hdfs</code>)</p>

<p>Note that the service name is part of the instance in the principal. The template of a principal with <code class="highlighter-rouge">hdfs</code> primary is:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>hdfs/&lt;pod-type&gt;-&lt;pod-index&gt;-&lt;task-type&gt;.&lt;service-name&gt;.autoip.dcos.thisdcos.directory@&lt;REALM&gt;
</code></pre>
</div>
<p>Given a service name of <code class="highlighter-rouge">hdfs-demo</code>, the principal for a name node becomes:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>hdfs/name-0-node.hdfs-demo.autoip.dcos.thisdcos.directory@LOCAL
</code></pre>
</div>

<p>Also note that if the service name is foldered, such as <code class="highlighter-rouge">myfolder/hdfs</code>, then the FQDN in the instance of the principal
becomes <code class="highlighter-rouge">myfolderhdfs</code>. For example:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>hdfs/name-0-node.myfolderhdfs.autoip.dcos.thisdcos.directory@LOCAL
</code></pre>
</div>

<h2 id="create-the-keytab-secret">Create the keytab secret</h2>

<p>Once the principals have been created, a keytab file must be generated and uploaded to the DC/OS secret store as a base-64-encoded value. Assuming the keytab for <strong>all</strong> the HDFS principals has been created as a file <code class="highlighter-rouge">keytab</code>, this can be added to the secret store as follows (note that the DC/OS Enterprise CLI needs to be installed to gain access to the <code class="highlighter-rouge">security</code> command):</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>base64 -w keytab &gt; keytab.base64
<span class="gp">$ </span>dcos security secrets create  __dcos_base64__keytab --value-file keytab.base64
</code></pre>
</div>

<p>The name of the secret created (<code class="highlighter-rouge">__dcos_base64__keytab</code>) can be changed, as long as the <code class="highlighter-rouge">__dcos__base64__</code> prefix is maintained.</p>

<h2 id="deploy-kerberized-hdfs">Deploy kerberized HDFS</h2>

<p>Create the following <code class="highlighter-rouge">kerberos-options.json</code> file:</p>
<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hdfs"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"security"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"kerberos"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                </span><span class="nt">"kdc"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nt">"hostname"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kdc.marathon.autoip.dcos.thisdcos.directory"</span><span class="p">,</span><span class="w">
                    </span><span class="nt">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">2500</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nt">"realm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LOCAL"</span><span class="p">,</span><span class="w">
                </span><span class="nt">"keytab_secret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"__dcos_base64__keytab"</span><span class="w">

            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p>Note the specification of the secret name as created in the previous step.</p>

<p>The kerberized Apache HDFS service is then deployed by running:</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>dcos package install hdfs --options<span class="o">=</span>kerberos-options.json
</code></pre>
</div>
