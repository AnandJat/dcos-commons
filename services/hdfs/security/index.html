<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">







<head>
<title>HDFS: Security</title>
<link rel="stylesheet" type="text/css" media="all" href="/dcos-commons/style/layout.css" />
<link rel="shortcut icon" type="image/png" href="https://mesosphere.com/favicon.ico"/>
<!-- The Dropdown library is written by Stephen Morley, licensed CC0 1.0 Universal (Public Domain Dedication)-->
<link rel="stylesheet" type="text/css" media="all" href="/dcos-commons/style/Dropdown.css" />
<script src="/dcos-commons/style/Dropdown.js"></script>
<style type="text/css">
/* set the background color of menu items */
.dropdown, .dropdown ul { background: #555555; clear: both; }
/* set the background color of active items */
.dropdown li:hover > a, .dropdown li:hover > span, .dropdown li.dropdownOpen > a, .dropdown li.dropdownOpen > span { background: #af87e0; }
/* pad items, set their text color, and fade their background color */
.dropdown a, .dropdown span { padding: 0.25em 0.5em; color: white; transition: background 0.2s; }
/* show '+' on expandable items */
.dropdown span:after { content: " +"; }

/* toc style: remove extra margin between elements */
.section-nav ul { margin: 0; }
</style>
</head>

<body>
<div id="wrapper">

<a href="/dcos-commons">
<img style="float: left; margin-bottom: 2em" src="https://mesosphere.com/wp-content/themes/mesosphere/library/images/assets/dcos-sdk-logo.png" width="250" alt="DC/OS Software Development Kit" />
</a>
<img style="float: right" src="https://img.shields.io/badge/Status-Alpha-BF97F0.svg?style=flat-square" alt="Status: Alpha" />

<ul class="dropdown" style="clear: both">
  <li>
    <a href="/dcos-commons">Home</a>
  </li>
  <li>
    <span>Documentation</span>
    <ul>
      
      
      
      
      <li><a href="/dcos-commons/operations-guide/">SDK Operations Guide</a></li>
      
      
      
      <li><a href="/dcos-commons/developer-guide/">SDK Developer Guide</a></li>
      
      
      
      <li><a href="/dcos-commons/yaml-reference/">YAML Reference</a></li>
      
      
      
      <li><a href="/dcos-commons/faq/">Frequently Asked Questions</a></li>
      
      
      
      <li><a href="/dcos-commons/glossary/">Glossary</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li><a href="/dcos-commons/reference/api">Javadoc Reference</a></li>
      <li><a href="/dcos-commons/reference/swagger-api">REST APIs</a></li>
    </ul>
  </li>
  <li>
    <span>Tutorials</span>
    <ul>
      
      
      
      <li><a href="/dcos-commons/tutorials/kafka-tutorial/">Kafka Tutorial</a></li>
      
      <li><a href="/dcos-commons/tutorials/secrets-tutorial/">Secrets Tutorial</a></li>
      
    </ul>
  </li>
  <li>
    <span>Services</span>
    <ul>
      
      
      
      
      <li>
        
        <span>Cassandra</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/service-settings/">Service Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/security/">Security</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/cassandra-settings/">Cassandra Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/node-settings/">Node Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/common-operations/">Common Operations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/overview/">Overview</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/diagnostic-tools/">Diagnostic Tools</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/disaster-recovery/">Disaster Recovery</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Elastic</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/elastic/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/elastic-x-pack/">X-Pack</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/security/">Security</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/custom-elasticsearch-yaml/">Custom Elasticsearch YAML</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/common-operations/">Common Operations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/diagnostic-tools/">Diagnostic Tools</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/overview/">Overview</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/disaster-recovery/">Disaster Recovery</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>HDFS</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/security/">Security</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/diagnostic-tools/">Diagnostic Tools</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/common-operations/">Common Operations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/overview/">Overview</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Kafka</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/kafka/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/security/">Security</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/common-operations/">Common Operations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/overview/">Overview</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/diagnostic-tools/">Diagnostic Tools</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
    </ul>
  </li>
  <li><a href="https://github.com/mesosphere/dcos-commons/blob/master/CONTRIBUTING.md">Contributing</a></li>
  <li><a href="http://chat.dcos.io" target="_blank">Slack</a></li>
</ul>
<h1>HDFS: Security</h1>
<div id="content">

<h1 id="dcos-apache-hdfs-security">DC/OS Apache HDFS Security</h1>

<p>The DC/OS Apache HDFS service supports HDFS’s native transport encryption, authentication, and authorization mechanisms. The service provides automation and orchestration to simplify the usage of these important features.</p>

<p>A good overview of these features can be found <a href="https://hadoop.apache.org/docs/r2.6.0/hadoop-project-dist/hadoop-common/SecureMode.html">here</a>.</p>

<p><em>Note</em>: These security features are only available on DC/OS Enterprise 1.10 and above.</p>

<h2 id="transport-encryption">Transport Encryption</h2>

<p>With transport encryption enabled, DC/OS Apache HDFS will automatically deploy all nodes with the correct configuration to encrypt communication via SSL. The nodes will communicate securely between themselves using SSL. Optionally, plaintext communication can be left open to clients.</p>

<p>The service uses the <a href="https://docs.mesosphere.com/latest/security/ent/tls-ssl/">DC/OS CA</a> to generate the SSL artifacts that it uses to secure the service. Any client that trusts the DC/OS CA will consider the service’s certificates valid.</p>

<p><em>Note</em>: Enabling transport encryption is not <em>required</em> to use <a href="#kerberos-authentication">Kerberos authentication</a>, but transport encryption <em>can</em> be combined with Kerberos authentication.</p>

<h3 id="prerequisites">Prerequisites</h3>
<ul>
  <li><a href="https://docs.mesosphere.com/latest/security/ent/service-auth/custom-service-auth/">A DC/OS Service Account with a secret stored in the DC/OS Secret Store</a>.</li>
  <li>DC/OS Superuser permissions for modifying the permissions of the Service Account.</li>
</ul>

<h3 id="configure-transport-encryption">Configure Transport Encryption</h3>

<h4 id="setup-the-service-account">Setup the Service Account</h4>

<p><a href="https://docs.mesosphere.com/latest/security/ent/perms-management/">Grant</a> the service account the correct permissions.</p>
<ul>
  <li>In DC/OS 1.10, the required permission is <code class="highlighter-rouge">dcos:superuser full</code>.</li>
  <li>In DC/OS 1.11+ the required permissions are:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dcos:secrets:default:/&lt;service name&gt;/* full
dcos:secrets:list:default:/&lt;service name&gt; read
dcos:adminrouter:ops:ca:rw full
dcos:adminrouter:ops:ca:ro full
</code></pre></div>    </div>
    <p>where <code class="highlighter-rouge">&lt;service name&gt;</code> is the name of the service to be installed.</p>
  </li>
</ul>

<h4 id="install-the-service">Install the service</h4>
<p>Install the DC/OS Apache HDFS service including the following options in addition to your own:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"service_account"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;your service account name&gt;"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"service_account_secret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;full path of service secret&gt;"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"security"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"transport_encryption"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                </span><span class="s2">"allow_plaintext"</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;</span><span class="kc">true</span><span class="err">|</span><span class="kc">false</span><span class="w"> </span><span class="err">default</span><span class="w"> </span><span class="kc">false</span><span class="err">&gt;</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="transport-encryption-clients">Transport Encryption Clients</h4>

<p>With Transport Encryption enabled, service clients will need to be configured to use <a href="https://docs.mesosphere.com/latest/security/ent/tls-ssl/get-cert/">the DC/OS CA bundle</a> to verify the connections they make to the service. Consult your client’s documentation for trusting a CA and configure your client appropriately.</p>

<!--
TO BE CONFIRMED
*Note*: It is possible to update a running DC/OS Apache HDFS service to enable transport encryption after initial installation, but the service may be unavilable during the transition. Additionally, your HDFS clients will need to be reconfigured unless `service.security.transport_encryption.allow_plaintext` is set to true. -->

<h2 id="authentication">Authentication</h2>

<p>DC/OS Apache HDFS supports Kerberos authentication.</p>

<h3 id="kerberos-authentication">Kerberos Authentication</h3>

<p>Kerberos authentication relies on a central authority to verify that HDFS clients are who they say they are. DC/OS Apache HDFS integrates with your existing Kerberos infrastructure to verify the identity of clients.</p>

<h4 id="prerequisites-1">Prerequisites</h4>
<ul>
  <li>The hostname and port of a KDC reachable from your DC/OS cluster</li>
  <li>Sufficient access to the KDC to create Kerberos principals</li>
  <li>Sufficient access to the KDC to retrieve a keytab for the generated principals</li>
  <li><a href="https://docs.mesosphere.com/latest/cli/enterprise-cli/#installing-the-dcos-enterprise-cli">The DC/OS Enterprise CLI</a></li>
  <li>DC/OS Superuser permissions</li>
</ul>

<h4 id="configure-kerberos-authentication">Configure Kerberos Authentication</h4>

<h4 id="create-principals">Create principals</h4>

<p>The DC/OS Apache HDFS service requires Kerberos principals for each node to be deployed. The overall topology of the HDFS service is:</p>
<ul>
  <li>3 journal nodes</li>
  <li>2 name nodes (with ZKFC)</li>
  <li>A configurable number of data nodes</li>
</ul>

<p><em>Note:</em> Apache HDFS requires a principal for both the <code class="highlighter-rouge">service primary</code> and <code class="highlighter-rouge">HTTP</code>. The latter is used by the HTTP api.</p>

<p>The required Kerberos principals will have the form:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;service primary&gt;/name-0-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
HTTP/name-0-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
&lt;service primary&gt;/name-0-zkfc.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
HTTP/name-0-zkfc.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
&lt;service primary&gt;/name-1-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
HTTP/name-1-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
&lt;service primary&gt;/name-1-zkfc.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
HTTP/name-1-zkfc.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;

&lt;service primary&gt;/journal-0-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
HTTP/journal-0-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
&lt;service primary&gt;/journal-1-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
HTTP/journal-1-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
&lt;service primary&gt;/journal-2-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
HTTP/journal-2-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;

&lt;service primary&gt;/data-&lt;data-index&gt;-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;
HTTP/data-&lt;data-index&gt;-node.&lt;service subdomain&gt;.autoip.dcos.thisdcos.directory@&lt;service realm&gt;

</code></pre></div></div>
<p>with:</p>
<ul>
  <li><code class="highlighter-rouge">service primary = service.security.kerberos.primary</code></li>
  <li><code class="highlighter-rouge">data index = 0 up to data_node.count - 1</code></li>
  <li><code class="highlighter-rouge">service subdomain = service.name with all </code>/<code class="highlighter-rouge">'s removed</code></li>
  <li><code class="highlighter-rouge">service realm = service.security.kerberos.realm</code></li>
</ul>

<p>For example, if installing with these options:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a/good/example"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"security"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"kerberos"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"primary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"example"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"realm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EXAMPLE"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"data_node"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>then the principals to create would be:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>example/name-0-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/name-0-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/name-0-zkfc.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/name-0-zkfc.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/name-1-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/name-1-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/name-1-zkfc.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/name-1-zkfc.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE

example/journal-0-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/journal-0-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/journal-1-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/journal-1-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/journal-2-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/journal-2-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE

example/data-0-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/data-0-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/data-1-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/data-1-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
example/data-2-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
HTTP/data-2-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
</code></pre></div></div>

<h5 id="active-directory">Active Directory</h5>

<p>Microsoft Active Directory can be used as a Kerberos KDC. Doing so requires creating a mapping between Active Directory users and Kerberos principals.</p>

<p>The utility <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/ktpass">ktpass</a> can be used to both create a keytab from Active Directory and generate the mapping at the same time.</p>

<p>The mapping <em>can</em>, however, be created manually. For a Kerberos principal like <code class="highlighter-rouge">&lt;primary&gt;/&lt;host&gt;@&lt;REALM&gt;</code>, the Active Directory user should have its <code class="highlighter-rouge">servicePrincipalName</code> and <code class="highlighter-rouge">userPrincipalName</code> attributes set to,</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>servicePrincipalName = &lt;primary&gt;/&lt;host&gt;
userPrincipalName = &lt;primary&gt;/&lt;host&gt;@&lt;REALM&gt;
</code></pre></div></div>

<p>For example, with the Kerberos principal <code class="highlighter-rouge">example/name-0-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE</code>, then the correct mapping would be,</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>servicePrincipalName = example/name-0-node.agoodexample.autoip.dcos.thisdcos.directory
userPrincipalName = example/name-0-node.agoodexample.autoip.dcos.thisdcos.directory@EXAMPLE
</code></pre></div></div>

<p>If either mapping is incorrect or not present, the service will fail to authenticate that Principal. The symptom in the Kerberos debug logs will be an error of the form</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KRBError:
sTime is Wed Feb 07 03:22:47 UTC 2018 1517973767000
suSec is 697984
error code is 6
error Message is Client not found in Kerberos database
sname is krbtgt/AD.MESOSPHERE.COM@AD.MESOSPHERE.COM
msgType is 30
</code></pre></div></div>
<p>when the <code class="highlighter-rouge">userPrincipalName</code> is set incorrectly, and an error of the form</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KRBError:
sTime is Wed Feb 07 03:44:57 UTC 2018 1517975097000
suSec is 128465
error code is 7
error Message is Server not found in Kerberos database
sname is kafka/kafka-1-broker.confluent-kafka.autoip.dcos.thisdcos.directory@AD.MESOSPHERE.COM
msgType is 30
</code></pre></div></div>
<p>when the <code class="highlighter-rouge">servicePrincipalName</code> is set incorrectly.</p>

<h4 id="place-service-keytab-in-dcos-secret-store">Place Service Keytab in DC/OS Secret Store</h4>

<p>The DC/OS Apache HDFS service uses a keytab containing all node principals (service keytab). After creating the principals above, generate the service keytab making sure to include all the node principals. This will be stored as a secret in the DC/OS Secret Store.</p>

<p><em>Note</em>: DC/OS 1.10 does not support adding binary secrets directly to the secret store, only text files are supported. Instead, first base64 encode the file, and save it to the secret store as <code class="highlighter-rouge">/desired/path/__dcos_base64__secret_name</code>. The DC/OS security modules will handle decoding the file when it is used by the service. More details <a href="https://docs.mesosphere.com/services/ops-guide/overview/#binary-secrets">here</a>.</p>

<p>The service keytab should be stored at <code class="highlighter-rouge">service/path/name/service.keytab</code> (as noted above for DC/OS 1.10, it would be <code class="highlighter-rouge">__dcos_base64__service.keytab</code>), where <code class="highlighter-rouge">service/path/name</code> matches the path and name of the service. For example, if installing with the options</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a/good/example"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>then the service keytab should be stored at <code class="highlighter-rouge">a/good/example/service.keytab</code>.</p>

<p>Documentation for adding a file to the secret store can be found <a href="https://docs.mesosphere.com/latest/security/ent/secrets/create-secrets/#creating-secrets-from-a-file-via-the-dcos-enterprise-cli">here</a>.</p>

<p><em>Note</em>: Secrets access is controlled by <a href="https://docs.mesosphere.com/latest/security/ent/#spaces-for-secrets">DC/OS Spaces</a>, which function like namespaces. Any secret in the same DC/OS Space as the service will be accessible by the service. However, matching the two paths is the most secure option. Additionally the secret name <code class="highlighter-rouge">service.keytab</code> is a convention and not a requirement.</p>

<h4 id="install-the-service-1">Install the Service</h4>

<p>Install the DC/OS Apache HDFS service with the following options in addition to your own:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"kerberos"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="s2">"kdc"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"hostname"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;kdc host&gt;"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"port"</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;kdc</span><span class="w"> </span><span class="err">port&gt;</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"primary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;service primary default hdfs&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"realm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;realm&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"keytab_secret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;path to keytab secret&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"debug"</span><span class="p">:</span><span class="w"> </span><span class="err">&lt;</span><span class="kc">true</span><span class="err">|</span><span class="kc">false</span><span class="w"> </span><span class="err">default</span><span class="w"> </span><span class="kc">false</span><span class="err">&gt;</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<!-- TO BE DETERMINED *Note*: It is possible to enable Kerberos after initial installation but the service may be unavailable during the transition. Additionally, your HDFS clients will need to be reconfigured. -->

<h2 id="authorization">Authorization</h2>

<p>The DC/OS Apache HDFS service supports HDFS’s native authorization, which behaves similarly to UNIX file permissions. If Keberos is enabled as detailed <a href="#kerberos-authentication">above</a>, then Kerberos principals are mapped to HDFS users against which permissions can be assigned.</p>

<h3 id="enable-authorization">Enable Authorization</h3>

<h4 id="prerequisites-2">Prerequisites</h4>
<ul>
  <li>Completion of  <a href="#kerberos-authentication">Kerberos authentication</a> above.</li>
</ul>

<h4 id="set-kerberos-principal-to-user-mapping">Set Kerberos Principal to User Mapping</h4>

<p>A custom mapping must be set to map Kerberos principals to OS user names for the purposes of determining group membership. This is supplied by setting the parameter</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "hdfs": {
        "security_auth_to_local": "&lt;custom mapping&gt;"
    }
}
</code></pre></div></div>
<p>where <code class="highlighter-rouge">&lt;custom mapping&gt;</code> is a base64-encoded string.</p>

<p><em>Note</em>: There is <em>no</em> default mapping. One <strong>MUST</strong> be set at install or update time.</p>

<p><a href="https://hortonworks.com/blog/fine-tune-your-apache-hadoop-security-settings/">This</a> article has a good description of how to build a custom mapping, under the section “Kerberos Principals and UNIX User Names”.</p>

<p><em>NOTE</em>: In DC/OS 1.11 and above, the DC/OS UI will automatically encode and decode the mapping to and from base64. If installing from the CLI or from the UI in a version older than DC/OS 1.11, it is necessary to do the encoding manually.</p>

</div>
</div>
</body>

</html>
