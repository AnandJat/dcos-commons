<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">







<head>
<title>Kafka: Uninstall</title>
<link rel="stylesheet" type="text/css" media="all" href="/dcos-commons/style/layout.css" />
<link rel="shortcut icon" type="image/png" href="https://mesosphere.com/favicon.ico"/>
<!-- The Dropdown library is written by Stephen Morley, licensed CC0 1.0 Universal (Public Domain Dedication)-->
<link rel="stylesheet" type="text/css" media="all" href="/dcos-commons/style/Dropdown.css" />
<script src="/dcos-commons/style/Dropdown.js"></script>
<style type="text/css">
/* set the background color of menu items */
.dropdown, .dropdown ul { background: #555555; clear: both; }
/* set the background color of active items */
.dropdown li:hover > a, .dropdown li:hover > span, .dropdown li.dropdownOpen > a, .dropdown li.dropdownOpen > span { background: #af87e0; }
/* pad items, set their text color, and fade their background color */
.dropdown a, .dropdown span { padding: 0.25em 0.5em; color: white; transition: background 0.2s; }
/* show '+' on expandable items */
.dropdown span:after { content: " +"; }

/* toc style: remove extra margin between elements */
.section-nav ul { margin: 0; }
</style>
</head>

<body>
<div id="wrapper">

<a href="/dcos-commons">
<img style="float: left; margin-bottom: 2em" src="https://mesosphere.com/wp-content/themes/mesosphere/library/images/assets/dcos-sdk-logo.png" width="250" alt="DC/OS Software Development Kit" />
</a>
<img style="float: right" src="https://img.shields.io/badge/Status-Alpha-BF97F0.svg?style=flat-square" alt="Status: Alpha" />

<ul class="dropdown" style="clear: both">
  <li>
    <a href="/dcos-commons">Home</a>
  </li>
  <li>
    <span>Documentation</span>
    <ul>
      
      
      
      
      <li><a href="/dcos-commons/operations-guide/">SDK Operations Guide</a></li>
      
      
      
      <li><a href="/dcos-commons/developer-guide/">SDK Developer Guide</a></li>
      
      
      
      <li><a href="/dcos-commons/yaml-reference/">YAML Reference</a></li>
      
      
      
      <li><a href="/dcos-commons/faq/">Frequently Asked Questions</a></li>
      
      
      
      <li><a href="/dcos-commons/glossary/">Glossary</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li><a href="/dcos-commons/reference/api">Javadoc Reference</a></li>
      <li><a href="/dcos-commons/reference/swagger-api">REST APIs</a></li>
    </ul>
  </li>
  <li>
    <span>Tutorials</span>
    <ul>
      
      
      
      <li><a href="/dcos-commons/tutorials/secrets-tutorial/">Secrets Tutorial</a></li>
      
      <li><a href="/dcos-commons/tutorials/kafka-tutorial/">Kafka Tutorial</a></li>
      
    </ul>
  </li>
  <li>
    <span>Services</span>
    <ul>
      
      
      
      
      <li>
        
        <span>Cassandra</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/service-settings/">Service Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/cassandra-settings/">Cassandra Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/node-settings/">Node Settings</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/diagnostic-tools/">Diagnostic Tools</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/common-operations/">Common Operations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/overview/">Overview</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/disaster-recovery/">Disaster Recovery</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/cassandra/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Elastic</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/elastic/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/elastic-x-pack/">X-Pack</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/custom-elasticsearch-yaml/">Custom Elasticsearch YAML</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/common-operations/">Common Operations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/diagnostic-tools/">Diagnostic Tools</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/overview/">Overview</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/disaster-recovery/">Disaster Recovery</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/elastic/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>HDFS</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/kerberos/">Kerberos</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/diagnostic-tools/">Diagnostic Tools</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/common-operations/">Common Operations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/overview/">Overview</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/hdfs/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Kafka</span>
        
        <ul>
          
          
          
          <li><a href="/dcos-commons/services/kafka/install/">Install and Customize</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/security/">Security</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/uninstall/">Uninstall</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/quick-start/">Quick Start</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/connecting-clients/">Connecting Clients</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/managing/">Managing</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/common-operations/">Common Operations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/diagnostic-tools/">Diagnostic Tools</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/api-reference/">API Reference</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/overview/">Overview</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/troubleshooting/">Troubleshooting</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/limitations/">Limitations</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/supported-versions/">Supported Versions</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/release-notes/">Release Notes</a></li>
          
          
          
          <li><a href="/dcos-commons/services/kafka/upgrade/">Upgrade</a></li>
          
          
        </ul>
      </li>
      
    </ul>
  </li>
  <li><a href="https://github.com/mesosphere/dcos-commons/blob/master/CONTRIBUTING.md">Contributing</a></li>
  <li><a href="http://chat.dcos.io" target="_blank">Slack</a></li>
</ul>
<h1>Kafka: Uninstall</h1>
<div id="content">


<!-- THIS CONTENT DUPLICATES THE DC/OS OPERATION GUIDE -->

<p>Support for an improved uninstall process was introduced in DC/OS 1.10. In order to take advantage of this new support, changes were required to the <code class="highlighter-rouge">beta-kafka</code> package, which were included as of versions 2.0.0-x and greater.</p>

<h3 id="dcos-110-and-newer-and-package-200-x-and-newer">DC/OS 1.10 and newer, and package 2.0.0-x and newer</h3>

<p>If you are using DC/OS 1.10 or newer and the installed service has a version greater than 2.0.0-x:</p>

<ol>
  <li>Uninstall the service. From the DC/OS CLI, enter <code class="highlighter-rouge">dcos package uninstall --app-id=&lt;instancename&gt; beta-kafka</code>.</li>
</ol>

<p>For example, to uninstall the Apache Kafka instance named <code class="highlighter-rouge">kafka-dev</code>, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dcos package uninstall <span class="nt">--app-id</span><span class="o">=</span>kafka-dev beta-kafka
</code></pre></div></div>

<h4 id="uninstall-flow">Uninstall flow</h4>

<p>Uninstalling the service consists of the following steps:</p>
<ul>
  <li>The scheduler is relaunched in Marathon with the environment variable <code class="highlighter-rouge">SDK_UNINSTALL</code> set to “true”. This puts the Scheduler in an uninstall mode.</li>
  <li>The scheduler performs the uninstall with the following actions:
    <ul>
      <li>All running tasks for the service are terminated so that Mesos will reoffer their resources.</li>
      <li>As the task resources are offered by Mesos, they are unreserved by the scheduler.
        <ul>
          <li><strong>Warning</strong>: Any data stored in reserved disk resources will be irretrievably lost.</li>
        </ul>
      </li>
      <li>Once all known resources have been unreserved, the scheduler’s persistent state in ZooKeeper is deleted.</li>
    </ul>
  </li>
  <li>The cluster automatically removes the scheduler task once it advertises the completion of the uninstall process.</li>
</ul>

<p>Note that once the uninstall operation has begun, it cannot be cancelled because it can leave the service in an uncertain, half-destroyed state.</p>

<h4 id="debugging-an-uninstall">Debugging an uninstall</h4>

<p>In the vast majority of cases, this uninstall process goes off without a hitch. However, in certain situations, there can be snags along the way. For example, perhaps a machine in the cluster has permanently gone away, and the service being uninstalled had some resources allocated on that machine. This can result in the uninstall becoming stuck, because Mesos will never offer those resources to the uninstalling scheduler. As such, the uninstalling scheduler will not be able to successfully unreserve the resources it had reserved on that machine.</p>

<p>This situation is indicated by looking at <code class="highlighter-rouge">deploy</code> plan while the uninstall is proceeding. The <code class="highlighter-rouge">deploy</code> plan may be viewed using either of the following methods:</p>
<ul>
  <li>CLI: <code class="highlighter-rouge">dcos beta-kafka --name=kafka plan show deploy</code> (after running <code class="highlighter-rouge">dcos package install --cli beta-kafka</code> if needed)</li>
  <li>HTTP: <code class="highlighter-rouge">https://yourcluster.com/service/kafka/v1/plans/deploy</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos beta-kafka <span class="nt">--name</span><span class="o">=</span>kafka plan show deploy
deploy <span class="o">(</span>IN_PROGRESS<span class="o">)</span>
├─ kill-tasks <span class="o">(</span>COMPLETE<span class="o">)</span>
│  ├─ kill-task-node-0-server__1a4114bc-48bb-47f6-be99-1b5ca6d55c4e <span class="o">(</span>COMPLETE<span class="o">)</span>
│  ├─ kill-task-node-1-server__0c42118e-04fd-40e1-b49d-0d3f71d2d243 <span class="o">(</span>COMPLETE<span class="o">)</span>
│  └─ kill-task-node-2-server__e00cad38-f27f-4332-b1df-5118ca480d50 <span class="o">(</span>COMPLETE<span class="o">)</span>
├─ unreserve-resources <span class="o">(</span>IN_PROGRESS<span class="o">)</span>
│  ├─ unreserve-f41351a2-b478-4e13-a94c-705f530989ef <span class="o">(</span>COMPLETE<span class="o">)</span>
│  ├─ unreserve-48f64612-8427-4cde-86f4-4edeb9efff37 <span class="o">(</span>COMPLETE<span class="o">)</span>
│  ├─ unreserve-402d51f5-6014-4ca3-bd13-324dae62b888 <span class="o">(</span>PENDING<span class="o">)</span>
│  ├─ unreserve-cb95e869-277f-48b9-954f-08c0d7a26bcf <span class="o">(</span>PENDING<span class="o">)</span>
│  ├─ unreserve-cbd748d0-df7b-4d01-b0b7-6acf915d8f98 <span class="o">(</span>COMPLETE<span class="o">)</span>
│  ├─ unreserve-00ed63d6-427c-4492-9713-772390cc5241 <span class="o">(</span>COMPLETE<span class="o">)</span>
│  ├─ unreserve-5dd56b1d-4522-4bbd-88b5-de9fa0f181f2 <span class="o">(</span>PENDING<span class="o">)</span>
│  └─ unreserve-c9915f07-f446-4e14-a6b4-12c8dd2f914b <span class="o">(</span>COMPLETE<span class="o">)</span>
└─ deregister-service <span class="o">(</span>PENDING<span class="o">)</span>
   └─ deregister <span class="o">(</span>PENDING<span class="o">)</span>
</code></pre></div></div>

<p>As we can see above, some of the resources to unreserve are stuck in a <code class="highlighter-rouge">PENDING</code> state. We can force them into a <code class="highlighter-rouge">COMPLETE</code> state, and thereby allow the scheduler to finish the uninstall operation. This may be done using either of the following methods:</p>
<ul>
  <li>CLI: <code class="highlighter-rouge">dcos beta-kafka --name=kafka plan show deploy</code></li>
  <li>HTTP: <code class="highlighter-rouge">https://yourcluster.com/service/kafka/v1/plans/deploy/forceComplete?phase=unreserve-resources&amp;step=unreserve-&lt;UUID&gt;</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos cassandra plan force-complete deploy unreserve-resources unreserve-402d51f5-6014-4ca3-bd13-324dae62b888
<span class="nv">$ </span>dcos cassandra plan force-complete deploy unreserve-resources unreserve-cb95e869-277f-48b9-954f-08c0d7a26bcf
<span class="nv">$ </span>dcos cassandra plan force-complete deploy unreserve-resources unreserve-5dd56b1d-4522-4bbd-88b5-de9fa0f181f2
</code></pre></div></div>

<p>At this point the scheduler should show a <code class="highlighter-rouge">COMPLETE</code> state for these steps in the plan, allowing it to proceed normally with the uninstall operation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dcos beta-kafka --name=kafka plan show deploy
deploy (IN_PROGRESS)
├─ kill-tasks (COMPLETE)
│  ├─ kill-task-node-0-server__1a4114bc-48bb-47f6-be99-1b5ca6d55c4e (COMPLETE)
│  ├─ kill-task-node-1-server__0c42118e-04fd-40e1-b49d-0d3f71d2d243 (COMPLETE)
│  └─ kill-task-node-2-server__e00cad38-f27f-4332-b1df-5118ca480d50 (COMPLETE)
├─ unreserve-resources (COMPLETE)
│  ├─ unreserve-f41351a2-b478-4e13-a94c-705f530989ef (COMPLETE)
│  ├─ unreserve-48f64612-8427-4cde-86f4-4edeb9efff37 (COMPLETE)
│  ├─ unreserve-402d51f5-6014-4ca3-bd13-324dae62b888 (COMPLETE)
│  ├─ unreserve-cb95e869-277f-48b9-954f-08c0d7a26bcf (COMPLETE)
│  ├─ unreserve-cbd748d0-df7b-4d01-b0b7-6acf915d8f98 (COMPLETE)
│  ├─ unreserve-00ed63d6-427c-4492-9713-772390cc5241 (COMPLETE)
│  ├─ unreserve-5dd56b1d-4522-4bbd-88b5-de9fa0f181f2 (COMPLETE)
│  └─ unreserve-c9915f07-f446-4e14-a6b4-12c8dd2f914b (COMPLETE)
└─ deregister-service (PENDING)
   └─ deregister (PENDING)
</code></pre></div></div>

<h4 id="manual-uninstall">Manual uninstall</h4>

<p>If all else fails, one can simply manually perform the uninstall themselves. To do this, perform the following steps:</p>
<ul>
  <li>Delete the uninstalling scheduler from Marathon.</li>
  <li>Unregister the service from Mesos using its UUID as follows:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos service <span class="nt">--inactive</span> | <span class="nb">grep </span>kafka
kafka     False     3    3.3  6240.0  15768.0  97a0fd27-8f27-4e14-b2f2-fb61c36972d7-0096

<span class="nv">$ </span>dcos service shutdown 97a0fd27-8f27-4e14-b2f2-fb61c36972d7-0096
</code></pre></div>    </div>
  </li>
  <li>Run <code class="highlighter-rouge">janitor.py</code> to clean up the remaining reserved resources, as described in the DC/OS 1.9 instructions below.</li>
</ul>

<h3 id="dcos-19-and-older-or-package-older-than-200-x">DC/OS 1.9 and older, or package older than 2.0.0-x</h3>

<p>If you are running DC/OS 1.9 or older, or a version of the service that is older than 2.0.0-x, follow these steps:</p>

<ol>
  <li>Stop the service. From the DC/OS CLI, enter <code class="highlighter-rouge">dcos package uninstall --app-id=&lt;instancename&gt; &lt;packagename&gt;</code>.
For example, <code class="highlighter-rouge">dcos package uninstall --app-id=kafka-dev beta-kafka</code>.</li>
  <li>Clean up remaining reserved resources with the framework cleaner script, <code class="highlighter-rouge">janitor.py</code>. See <a href="https://docs.mesosphere.com/1.9/deploying-services/uninstall/#framework-cleaner">DC/OS documentation</a> for more information about the framework cleaner script.</li>
</ol>

<p>For example, to uninstall Apache Kafka instance named <code class="highlighter-rouge">kafka-dev</code>, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ MY_SERVICE_NAME</span><span class="o">=</span>kafka-dev
<span class="nv">$ </span>dcos package uninstall <span class="nt">--app-id</span><span class="o">=</span><span class="nv">$MY_SERVICE_NAME</span> beta-kafka<span class="sb">`</span><span class="nb">.</span>
<span class="nv">$ </span>dcos node ssh <span class="nt">--master-proxy</span> <span class="nt">--leader</span> <span class="s2">"docker run mesosphere/janitor /janitor.py </span><span class="se">\</span><span class="s2">
    -r </span><span class="nv">$MY_SERVICE_NAME</span><span class="s2">-role </span><span class="se">\</span><span class="s2">
    -p </span><span class="nv">$MY_SERVICE_NAME</span><span class="s2">-principal </span><span class="se">\</span><span class="s2">
    -z dcos-service-</span><span class="nv">$MY_SERVICE_NAME</span><span class="s2">"</span>
</code></pre></div></div>

<!-- END DUPLICATE BLOCK -->


</div>
</div>
</body>

</html>
