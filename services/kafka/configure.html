<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">







<head>
<title>Kafka: Configure</title>
<link rel="stylesheet" type="text/css" media="all" href="../../style/gh-basic.css" />
<link rel="shortcut icon" type="image/png" href="https://mesosphere.com/favicon.ico"/>
<!-- The Dropdown library is written by Stephen Morley, licensed CC0 1.0 Universal (Public Domain Dedication)-->
<link rel="stylesheet" type="text/css" media="all" href="../../style/Dropdown.css" />
<script src="../../style/Dropdown.js"></script>
<style type="text/css">
/* set the background color of menu items */
.dropdown, .dropdown ul { background: #555555; clear: both; }
/* set the background color of active items */
.dropdown li:hover > a, .dropdown li:hover > span, .dropdown li.dropdownOpen > a, .dropdown li.dropdownOpen > span { background: #af87e0; }
/* pad items, set their text color, and fade their background color */
.dropdown a, .dropdown span { padding: 0.25em 0.5em; color: white; transition: background 0.2s; }
/* show '+' on expandable items */
.dropdown span:after { content: " +"; }

/* toc style: remove extra margin between elements */
#markdown-toc ul { margin: 0; }
</style>
</head>

<body>
<div id="wrapper">

<a href="../..">
<img style="float: left; margin-bottom: 2em" src="https://mesosphere.com/wp-content/themes/mesosphere/library/images/assets/dcos-sdk-logo.png" width="250" alt="DC/OS Software Development Kit" />
</a>
<img style="float: right" src="https://img.shields.io/badge/Status-Alpha-BF97F0.svg?style=flat-square" alt="Status: Alpha" />

<ul class="dropdown" style="clear: both">
  <li>
    <a href="../..">Home</a>
  </li>
  <li>
    <span>Documentation</span>
    <ul>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li><a href="../../developer-guide.html">SDK Developer Guide</a></li>
      
      
      
      <li><a href="../../operations-guide.html">SDK Operations Guide</a></li>
      
      
      
      <li><a href="../../faq.html">Frequently Asked Questions</a></li>
      
      
      
      <li><a href="../../glossary.html">Glossary</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </li>
  <li>
    <span>Tutorials</span>
    <ul>
      
      
      
      <li><a href="../../tutorials/kafka-tutorial.html">Kafka Tutorial</a></li>
      
      <li><a href="../../tutorials/secrets-tutorial.html">Secrets Tutorial</a></li>
      
      <li><a href="../../tutorials/quick-start-java.html">Quick Start (Java)</a></li>
      
    </ul>
  </li>
  <li>
    <span>Reference</span>
    <ul>
      
      <li><a href="../../reference/api">Javadoc Reference</a></li>
      <li><a href="../../reference/swagger-api">REST APIs</a></li>
      <li><a href="../../reference/yaml-reference.html">YAML Reference</a></li>
    </ul>
  </li>
  <li>
    <span>Services</span>
    <ul>
      
      
      
      
      <li>
        
        <span>Elastic</span>
        
        <ul>
          
          
          <li><a href="../../services/elastic/install.html">Install and Customize</a></li>
          
          <li><a href="../../services/elastic/quick-start.html">Quick Start</a></li>
          
          <li><a href="../../services/elastic/upgrade.html">Upgrade</a></li>
          
          <li><a href="../../services/elastic/uninstall.html">Uninstall</a></li>
          
          <li><a href="../../services/elastic/configure.html">Configuring</a></li>
          
          <li><a href="../../services/elastic/x-pack.html">X-Pack</a></li>
          
          <li><a href="../../services/elastic/connecting.html">Connecting Clients</a></li>
          
          <li><a href="../../services/elastic/backup_restore.html">Backup and Restore</a></li>
          
          <li><a href="../../services/elastic/managing.html">Managing</a></li>
          
          <li><a href="../../services/elastic/api-reference.html">API Reference</a></li>
          
          <li><a href="../../services/elastic/troubleshooting.html">Troubleshooting</a></li>
          
          <li><a href="../../services/elastic/version_policy.html">Version Policy</a></li>
          
          <li><a href="../../services/elastic/release-notes.html">Release Notes</a></li>
          
          <li><a href="../../services/elastic/limitations.html">Limitations</a></li>
          
          <li><a href="../../services/elastic/changelog.html">Changelog</a></li>
          
        </ul>
      </li>
      
      <li>
        
        <span>HDFS</span>
        
        <ul>
          
          
          <li><a href="../../services/hdfs/quick-start.html">Quickstart</a></li>
          
          <li><a href="../../services/hdfs/install.html">Install and Customize</a></li>
          
          <li><a href="../../services/hdfs/uninstall.html">Uninstall</a></li>
          
          <li><a href="../../services/hdfs/release-notes.html">Release Notes</a></li>
          
          <li><a href="../../services/hdfs/configure.html">Configuring</a></li>
          
          <li><a href="../../services/hdfs/connecting-clients.html">Connecting Clients</a></li>
          
          <li><a href="../../services/hdfs/managing.html">Managing</a></li>
          
          <li><a href="../../services/hdfs/limitations.html">Limitations</a></li>
          
          <li><a href="../../services/hdfs/api-reference.html">API Reference</a></li>
          
          <li><a href="../../services/hdfs/troubleshooting.html">Troubleshooting</a></li>
          
        </ul>
      </li>
      
      <li>
        
        <span>Kafka</span>
        
        <ul>
          
          
          <li><a href="../../services/kafka/install-and-customize.html">Install and Customize</a></li>
          
          <li><a href="../../services/kafka/quick-start.html">Quick Start</a></li>
          
          <li><a href="../../services/kafka/uninstall.html">Uninstall</a></li>
          
          <li><a href="../../services/kafka/configure.html">Configure</a></li>
          
          <li><a href="../../services/kafka/connecting-clients.html">Connecting Clients</a></li>
          
          <li><a href="../../services/kafka/managing.html">Managing</a></li>
          
          <li><a href="../../services/kafka/api-reference.html">API Reference</a></li>
          
          <li><a href="../../services/kafka/troubleshooting.html">Troubleshooting</a></li>
          
          <li><a href="../../services/kafka/version-policy.html">Version Policy</a></li>
          
          <li><a href="../../services/kafka/limitations.html">Limitations</a></li>
          
          <li><a href="../../services/kafka/upgrade.html">Upgrade `1.1.16-0.10.1.0-beta` to `2.0.0-0.11.0.0`</a></li>
          
        </ul>
      </li>
      
    </ul>
  </li>
  <li><a href="https://github.com/mesosphere/dcos-commons/blob/master/CONTRIBUTING.md">Contributing</a></li>
  <li><a href="http://chat.dcos.io" target="_blank">Slack</a></li>
</ul>
<h1>Kafka: Configure</h1>
<div id="content">
<p><a name="changing-configuration-at-runtime"></a></p>
<h1 id="changing-configuration-at-runtime">Changing Configuration at Runtime</h1>

<p>You can customize your cluster in-place when it is up and running.</p>

<p>The Kafka scheduler runs as a Marathon process and can be reconfigured by changing values from the DC/OS web interface. These are the general steps to follow:</p>

<ol>
  <li>Go to the <code class="highlighter-rouge">Services</code> tab of the DC/OS web interface.</li>
  <li>Click the name of the Kafka service to be updated.</li>
  <li>Within the Kafka instance details view, click the menu in the upper right, then choose <strong>Edit</strong>.</li>
  <li>In the dialog that appears, click the <strong>Environment</strong> tab and update any field(s) to their desired value(s). For example, to <a href="#broker-count">increase the number of Brokers</a>, edit the value for <code class="highlighter-rouge">BROKER_COUNT</code>. Do not edit the value for <code class="highlighter-rouge">FRAMEWORK_NAME</code> or <code class="highlighter-rouge">BROKER_DISK</code>.</li>
  <li>Choose a <code class="highlighter-rouge">DEPLOY_STRATEGY</code>: serial, serial-canary, parallel-canary, or parallel. See the SDK Developer guide for more information on <a href="https://mesosphere.github.io/dcos-commons/developer-guide.html#plans">deployment plan strategies</a>. <!-- I'm not sure I like this solution, since users aren't going to have the context for the dev guide). --></li>
  <li>Click <strong>REVIEW &amp; RUN</strong> to apply any changes and cleanly reload the Kafka scheduler. The Kafka cluster itself will persist across the change.</li>
</ol>

<h2 id="configuration-update-rest-api">Configuration Update REST API</h2>

<p>Make the REST request below to view the current deployment plan. See the REST API Authentication part of the REST API Reference section for information on how this request must be authenticated.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -H "Authorization: token=$auth_token" "&lt;dcos_url&gt;/service/kafka/v1/plan"

{
  "phases" : [
    {
      "id" : "b6180a4e-b25f-4307-8855-0b37d671fd46",
      "name" : "Deployment",
      "steps" : [
        {
          "id" : "258f19a4-d6bc-4ff1-8685-f314924884a1",
          "status" : "COMPLETE",
          "name" : "kafka-0:[broker]",
          "message" : "com.mesosphere.sdk.scheduler.plan.DeploymentStep: 'kafka-0:[broker] [258f19a4-d6bc-4ff1-8685-f314924884a1]' has status: 'COMPLETE'."
        },
        {
          "id" : "e59fb2a9-22e2-4900-89e3-bda24041639f",
          "status" : "COMPLETE",
          "name" : "kafka-1:[broker]",
          "message" : "com.mesosphere.sdk.scheduler.plan.DeploymentStep: 'kafka-1:[broker] [e59fb2a9-22e2-4900-89e3-bda24041639f]' has status: 'COMPLETE'."
        },
        {
          "id" : "0b5a5048-fd3a-4b2c-a9b5-746045176d29",
          "status" : "COMPLETE",
          "name" : "kafka-2:[broker]",
          "message" : "com.mesosphere.sdk.scheduler.plan.DeploymentStep: 'kafka-2:[broker] [0b5a5048-fd3a-4b2c-a9b5-746045176d29]' has status: 'COMPLETE'."
        }
      ],
    "status" : "COMPLETE"
  }
],
"errors" : [ ],
"status" : "COMPLETE"   }
</code></pre>
</div>

<!-- need to update this with current information for different deployments
When using the `STAGE` deployment strategy, an update plan will initially pause without doing any update to ensure the plan is correct. It will look like this:

    curl -H "Authorization: token=$auth_token" "<dcos_url>/service/kafka/v1/plan"
    GET <dcos_url>/service/kafka/v1/plan HTTP/1.1

    {
      "phases": [
        {
          "id": "9f8927de-d0df-4f72-bd0d-55e3f2c3ab21",
          "name": "Reconciliation",
          "steps": [
            {
              "id": "2d137273-249b-455e-a65c-3c83228890b3",
              "status": "COMPLETE",
              "name": "Reconciliation",
              "message": "Reconciliation complete"
            }
          ],
          "status": "COMPLETE"
        },
        {
          "id": "a7742963-f7e1-4640-8bd0-2fb28dc04045",
          "name": "Update to: 6092e4ec-8ffb-49eb-807b-877a85ef8859",
          "steps": [
            {
              "id": "b4453fb0-b4cc-4996-a05c-762673f75e6d",
              "status": "PENDING",
              "name": "broker-0",
              "message": "Broker-0 is WAITING"
            },
            {
              "id": "b8a8de9f-8758-4d0f-b785-0a38751a2c94",
              "status": "PENDING",
              "name": "broker-1",
              "message": "Broker-1 is WAITIN"
            },
            {
              "id": "49e85522-1bcf-4edb-9456-712e8a537dbc",
              "status": "PENDING",
              "name": "broker-2",
              "message": "Broker-2 is PENDING"
            }
          ],
          "status": "WAITING"
        }
      ],
      "errors": [],
      "status": "WAITING"
    }
-->
<p><strong>Note:</strong> After a configuration update, you may see an error from Mesos-DNS; this will go away 10 seconds after the update.</p>

<p>Enter the <code class="highlighter-rouge">continue</code> command to execute the first step:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -X PUT -H "Authorization: token=$auth_token" "&lt;dcos_url&gt;/service/kafka/v1/plan?cmd=continue"
PUT &lt;dcos_url&gt;/service/kafka/v1/continue HTTP/1.1

{
    "Result": "Received cmd: continue"
}
</code></pre>
</div>

<p>After you execute the continue operation, the plan will look like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -H "Authorization: token=$auth_token" "&lt;dcos_url&gt;/service/kafka/v1/plan"
GET &lt;dcos_url&gt;/service/kafka/v1/plan HTTP/1.1

{
  "phases": [
    {
      "id": "9f8927de-d0df-4f72-bd0d-55e3f2c3ab21",
      "name": "Reconciliation",
      "steps": [
        {
          "id": "2d137273-249b-455e-a65c-3c83228890b3",
          "status": "COMPLETE",
          "name": "Reconciliation",
          "message": "Reconciliation complete"
        }
      ],
      "status": "COMPLETE"
    },
    {
      "id": "a7742963-f7e1-4640-8bd0-2fb28dc04045",
      "name": "Update to: 6092e4ec-8ffb-49eb-807b-877a85ef8859",
      "steps": [
        {
          "id": "b4453fb0-b4cc-4996-a05c-762673f75e6d",
          "status": "IN_PROGRESS",
          "name": "broker-0",
          "message": "Broker-0 is IN_PROGRESS"
        },
        {
          "id": "b8a8de9f-8758-4d0f-b785-0a38751a2c94",
          "status": "WAITING",
          "name": "broker-1",
          "message": "Broker-1 is WAITING"
        },
        {
          "id": "49e85522-1bcf-4edb-9456-712e8a537dbc",
          "status": "PENDING",
          "name": "broker-2",
          "message": "Broker-2 is PENDING"
        }
      ],
      "status": "IN_PROGRESS"
    }
  ],
  "errors": [],
  "status": "IN_PROGRESS"
}
</code></pre>
</div>

<p>If you enter <code class="highlighter-rouge">continue</code> a second time, the rest of the plan will be executed without further interruption. If you want to interrupt a configuration update that is in progress, enter the <code class="highlighter-rouge">interrupt</code> command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -X PUT -H "Authorization: token=$auth_token"  "&lt;dcos_url&gt;/service/kafka/v1/plan?cmd=interrupt"
PUT &lt;dcos_url&gt;/service/kafka/v1/interrupt HTTP/1.1

{
    "Result": "Received cmd: interrupt"
}
</code></pre>
</div>

<p><strong>Note:</strong> The interrupt command can’t stop a step that is <code class="highlighter-rouge">InProgress</code>, but it will stop the change on the subsequent steps.</p>

<p><a name="configuration-options"></a></p>
<h1 id="configuration-options">Configuration Options</h1>

<p>The following describes the most commonly used features of the Kafka service and how to configure them via the DC/OS CLI and from the DC/OS web interface. View the <a href="https://github.com/mesosphere/universe/tree/1-7ea/repo/packages/K/kafka/6">default <code class="highlighter-rouge">config.json</code> in DC/OS Universe</a> to see all possible configuration options.</p>

<h2 id="service-name">Service Name</h2>

<p>The name of this Kafka instance in DC/OS. This is an option that cannot be changed once the Kafka cluster is started: it can only be configured via the DC/OS CLI <code class="highlighter-rouge">--options</code> flag when the Kafka instance is created.</p>

<ul>
  <li><strong>In DC/OS CLI options.json</strong>: <code class="highlighter-rouge">name</code>: string (default: <code class="highlighter-rouge">kafka</code>)</li>
  <li><strong>DC/OS web interface</strong>: The service name cannot be changed after the cluster has started.</li>
</ul>

<h2 id="kill-grace-period">Kill Grace Period</h2>

<p>The kiill grace period is the number of seconds each broker has to cleanly shut
down in response to SIGTERM. If a broker exceeds this time, it will be killed.
Use the <code class="highlighter-rouge">brokers.kill_grace_period</code> configuration option to set a kill grace period.</p>

<p>The graceful shutdown feature is especially important for large-scale deployments.
Use the graceful shutdown configuraiton option to provide the broker sufficient
time during shutdown. This ensure that all in-memory data is flushed to disk and
all state is replicated. When a broker has sufficient time to shut down, the
subsequent restart will be nearly as fast as the first startup. This is a large
contributor to the Kafka service’s high availability.</p>

<p>You can observe the graceful shutdown feature via the following log entries:</p>

<ol>
  <li>The task launch log line contains <code class="highlighter-rouge">kill_policy { grace_period { nanoseconds: 30000000000 } }</code>.</li>
  <li>The task graceful shutdown log line contains SIGTERM as well as the grace time granted.</li>
  <li>The underlying Kafka logging of shutdown operations includes a stream of subsystem shutdowns prior to the overarching system
shutdown indicated by the entry <code class="highlighter-rouge">[Kafka Server 1], shut down completed (kafka.server.KafkaServer)</code>.</li>
  <li>The presence (or not) of a SIGKILL log line indicating that the underlying Kafka broker did not shutdown cleanly within the
allotted grace period.</li>
  <li>The task status update marked by <code class="highlighter-rouge">TASK_KILLED</code>, indicating the end of the shutdown activity.</li>
</ol>

<h2 id="broker-count">Broker Count</h2>

<p>Configure the number of brokers running in a given Kafka cluster. The default count at installation is three brokers. This number may be increased, but not decreased, after installation.</p>

<ul>
  <li><strong>In DC/OS CLI options.json</strong>: <code class="highlighter-rouge">broker-count</code>: integer (default: <code class="highlighter-rouge">3</code>)</li>
  <li><strong>DC/OS web interface</strong>: <code class="highlighter-rouge">BROKER_COUNT</code>: <code class="highlighter-rouge">integer</code></li>
</ul>

<h2 id="broker-port">Broker Port</h2>

<p>Configure the port number that the brokers listen on. If the port is set to a particular value, this will be the port used by all brokers. The default port is 9092.  Note that this requires that <code class="highlighter-rouge">placement-strategy</code> be set to <code class="highlighter-rouge">NODE</code> to take effect, since having every broker listening on the same port requires that they be placed on different hosts. Setting the port to 0 indicates that each Broker should have a random port in the 9092-10092 range.</p>

<ul>
  <li><strong>In DC/OS CLI options.json</strong>: <code class="highlighter-rouge">broker-port</code>: integer (default: <code class="highlighter-rouge">9092</code>)</li>
  <li><strong>DC/OS web interface</strong>: <code class="highlighter-rouge">BROKER_PORT</code>: <code class="highlighter-rouge">integer</code></li>
</ul>

<h3 id="tls-broker-port">TLS Broker Port</h3>

<p>Configure the port number that brokers listen on with a TLS connection. The default value is <code class="highlighter-rouge">9093</code>. Same rules apply as for <a href="#broker-port">Broker Port</a>.</p>

<p>This setting requires <a href="#tls">TLS</a> to be enabled, otherwise it is ignored.</p>

<ul>
  <li><strong>In DC/OS CLI options.json</strong>: <code class="highlighter-rouge">broker-port_tls</code>: integer (default: <code class="highlighter-rouge">9093</code>)</li>
  <li><strong>DC/OS web interface</strong>: <code class="highlighter-rouge">BROKER_PORT_TLS</code>: <code class="highlighter-rouge">integer</code></li>
</ul>

<h2 id="configure-broker-placement-strategy-">Configure Broker Placement Strategy <!-- replace this with a discussion of PLACEMENT_CONSTRAINTS? --></h2>

<p><code class="highlighter-rouge">ANY</code> allows brokers to be placed on any node with sufficient resources, while <code class="highlighter-rouge">NODE</code> ensures that all brokers within a given Kafka cluster are never colocated on the same node. This is an option that cannot be changed once the Kafka cluster is started: it can only be configured via the DC/OS CLI <code class="highlighter-rouge">--options</code> flag when the Kafka instance is created.</p>

<ul>
  <li><strong>In DC/OS CLI options.json</strong>: <code class="highlighter-rouge">placement-strategy</code>: <code class="highlighter-rouge">ANY</code> or <code class="highlighter-rouge">NODE</code> (default: <code class="highlighter-rouge">ANY</code>)</li>
  <li><strong>DC/OS web interface</strong>: <code class="highlighter-rouge">PLACEMENT_STRATEGY</code>: <code class="highlighter-rouge">ANY</code> or <code class="highlighter-rouge">NODE</code></li>
</ul>

<h2 id="configure-kafka-broker-properties">Configure Kafka Broker Properties</h2>

<p>Kafka Brokers are configured through settings in a server.properties file deployed with each Broker. The settings here can be specified at installation time or during a post-deployment configuration update. They are set in the DC/OS Universe’s config.json as options such as:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>"log_retention_hours": {
    "title": "log.retention.hours",
    "description": "Override log.retention.hours: The number of hours to keep a log file before deleting it (in hours), tertiary to log.retention.ms property",
    "type": "integer",
    "default": 168
},
</code></pre>
</div>

<p>The defaults can be overridden at install time by specifying an options.json file with a format like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"kafka"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"log_retention_hours"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>These same values are also represented as environment variables for the scheduler in the form <code class="highlighter-rouge">KAFKA_OVERRIDE_LOG_RETENTION_HOURS</code> and may be modified through the DC/OS web interface and deployed during a rolling upgrade as <a href="#changing-configuration-at-runtime">described here</a>.</p>

<p><a name="disk-type"></a></p>
<h2 id="disk-type">Disk Type</h2>

<p>The type of disks that can be used for storing broker data are: <code class="highlighter-rouge">ROOT</code> (default) and <code class="highlighter-rouge">MOUNT</code>.  The type of disk may only be specified at install time.</p>

<ul>
  <li><code class="highlighter-rouge">ROOT</code>: Broker data is stored on the same volume as the agent work directory. Broker tasks will use the configured amount of disk space.</li>
  <li><code class="highlighter-rouge">MOUNT</code>: Broker data will be stored on a dedicated volume attached to the agent. Dedicated MOUNT volumes have performance advantages and a disk error on these MOUNT volumes will be correctly reported to Kafka.</li>
</ul>

<p>Configure Kafka service to use dedicated disk volumes:</p>
<ul>
  <li><strong>DC/OS cli options.json</strong>:</li>
</ul>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"brokers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"disk_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MOUNT"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">DISK_TYPE</code>: <code class="highlighter-rouge">MOUNT</code></li>
</ul>

<p>When configured to <code class="highlighter-rouge">MOUNT</code> disk type, the scheduler selects a disk on an agent whose capacity is equal to or greater than the configured <code class="highlighter-rouge">disk</code> value.</p>

<h2 id="jvm-heap-size">JVM Heap Size</h2>

<p>Kafka service allows configuration of JVM Heap Size for the broker JVM process. To configure it:</p>
<ul>
  <li><strong>DC/OS cli options.json</strong>:</li>
</ul>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"brokers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"heap"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nt">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">BROKER_HEAP_MB</code>: <code class="highlighter-rouge">2000</code></li>
</ul>

<p><strong>Note</strong>: The total memory allocated for the Mesos task is specified by the <code class="highlighter-rouge">BROKER_MEM</code> configuration parameter. The value for <code class="highlighter-rouge">BROKER_HEAP_MB</code> should not be greater than <code class="highlighter-rouge">BROKER_MEM</code> value. Also, if <code class="highlighter-rouge">BROKER_MEM</code> is greater than <code class="highlighter-rouge">BROKER_HEAP_MB</code> then the Linux operating system will use <code class="highlighter-rouge">BROKER_MEM</code> - <code class="highlighter-rouge">BROKER_HEAP_MB</code> for <a href="https://en.wikipedia.org/wiki/Page_cache">PageCache</a>.</p>

<h2 id="alternate-zookeeper">Alternate ZooKeeper</h2>

<p>By default the Kafka framework uses the ZooKeeper ensemble made available on the Mesos masters of a DC/OS cluster. You can configure an alternate ZooKeeper at install time.
To configure it:</p>
<ul>
  <li><strong>DC/OS CLI options.json</strong>:</li>
</ul>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"kafka"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nt">"kafka_zookeeper_uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"zookeeper.marathon.autoip.dcos.thisdcos.directory:2181"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>This configuration option cannot be changed after installation.</p>

<h2 id="tls">TLS</h2>

<p>It is possible to expose Kafka over a secure TLS connection.</p>

<p><strong>DC/OS CLI options.json</strong>:</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"tls"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Once the TLS is enabled, Kafka will use secure TLS connections for inter-node communication. Additional TLS port named <code class="highlighter-rouge">broker-tls</code> will be available for clients connecting to the service. Only the <a href="https://www.ietf.org/rfc/rfc5246.txt"><code class="highlighter-rouge">TLS version 1.2</code></a> is supported. The non-TLS <code class="highlighter-rouge">broker</code> port will still be available.</p>

<p>Enabling the TLS is possible only in <code class="highlighter-rouge">permissive</code> or <code class="highlighter-rouge">strict</code> cluster security modes. Both modes <strong>require</strong> a <a href="https://docs.mesosphere.com/service-docs/kafka/kafka-auth/">service account</a>. Additionally, the service account <strong>must have</strong> the <code class="highlighter-rouge">dcos:superuser</code> permission. If the permission is missing the Kafka scheduler will not abe able to provision the TLS artifacts.</p>

<p>There is a performance impact with TLS connections that should be considered:</p>

<ul>
  <li>
    <p>the initial TLS handshake</p>
  </li>
  <li>
    <p>encryption and decryption of messages sent over the socket</p>
  </li>
</ul>

<p>It is possible to use the Kafka CLI utility to test the performance impact of TLS by comparing the output of following commands:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>export KAFKA_TOPIC_NAME=tls-test
export KAFKA_MSG_COUNT=100000
dcos kafka topic create ${KAFKA_TOPIC_NAME}

# Test no TLS
dcos kafka topic producer_test ${KAFKA_TOPIC_NAME} ${KAFKA_MSG_COUNT}

# Test TLS
dcos kafka topic producer_test_tls ${KAFKA_TOPIC_NAME} ${KAFKA_MSG_COUNT}
</code></pre>
</div>

<p>For more information about the TLS in the SDK see <a href="https://mesosphere.github.io/dcos-commons/developer-guide.html#tls">the TLS documentation</a>.</p>

<h3 id="tls-and-plaintext">TLS and plaintext</h3>

<p>It is possible to keep both TLS and plaintext ports opened at the same time and have clients accessing both of them. To keep the plaintext port open use the following TLS configuration:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nt">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nt">"tls"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nt">"tls_allow_plaintext"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>The plaintext port will be disabled by default when the TLS is enabled.</p>

<h2 id="recovery-and-health-checks">Recovery and Health Checks</h2>

<p>You can enable automated replacement of brokers and configure the circumstances under which they are replaced.</p>

<h3 id="enable-broker-replacement">Enable Broker Replacement</h3>

<p>To enable automated replacement:</p>

<ul>
  <li><strong>DC/OS CLI options.json</strong>:</li>
</ul>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"enable_replacement"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"Enable automated replacement of Brokers. WARNING: May cause data loss. See documentation."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"boolean"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="kc">false</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">ENABLE_REPLACEMENT</code>: <code class="highlighter-rouge">true</code> to enable replacement.</li>
</ul>

<p><strong>Warning:</strong> The replacement mechanism is unaware of whether the broker it is destructively replacing had the latest copy of data. Depending on your replication policy and the degree and duration of the permanent failures, you may lose data.</p>

<p>The following configuration options control the circumstances under which a broker is replaced.</p>

<h3 id="minumum-grace-period">Minumum Grace Period</h3>

<p>Configure the minimum amount of time before a broker should be replaced:</p>

<ul>
  <li><strong>DC/OS CLI options.json</strong>:</li>
</ul>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">   
        </span><span class="nt">"recover_in_place_grace_period_secs"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"The minimum amount of time (in minutes) which must pass before a Broker may be destructively replaced."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="mi">1200</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">RECOVERY_GRACE_PERIOD_SEC</code>: <code class="highlighter-rouge">1200</code></li>
</ul>

<h3 id="minumum-delay-between-replacements">Minumum Delay Between Replacements</h3>

<p>Configure the minimum amount of time between broker replacements.</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"min_delay_between_recovers_secs"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"The minimum amount of time (in seconds) which must pass between destructive replacements of Brokers."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="mi">600</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">REPLACE_DELAY_SEC</code>: <code class="highlighter-rouge">600</code></li>
</ul>

<p>The following configurations control the health checks that determine when a broker has failed:</p>

<h3 id="enable-health-check">Enable Health Check</h3>

<p>Enable health checks on brokers:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"enable_health_check"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"Enable automated detection of Broker failures which did not result in a Broker process exit."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"boolean"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="kc">true</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">ENABLE_BROKER_HEALTH_CHECK</code>: <code class="highlighter-rouge">true</code></li>
</ul>

<h3 id="health-check-delay">Health Check Delay</h3>

<p>Set the amount of time before the health check begins:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"health_check_delay_sec"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"The period of time (in seconds) waited before the health-check begins execution."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="mi">15</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">BROKER_HEALTH_CHECK_DELAY_SEC</code>: <code class="highlighter-rouge">15</code></li>
</ul>

<h3 id="health-check-interval">Health Check Interval</h3>

<p>Set the interval between health checks:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"health_check_interval_sec"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"The period of time (in seconds) between health-check executions."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="mi">10</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">BROKER_HEALTH_CHECK_INTERVAL_SEC</code>: <code class="highlighter-rouge">10</code></li>
</ul>

<h3 id="health-check-timeout">Health Check Timeout</h3>

<p>Set the time a health check can take to complete before it is considered a failed check:</p>
<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"health_check_timeout_sec"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"The duration (in seconds) allowed for a health-check to complete before it is considered a failure."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="mi">20</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">BROKER_HEALTH_CHECK_TIMEOUT_SEC</code>: <code class="highlighter-rouge">20</code></li>
</ul>

<h3 id="health-check-grace-period">Health Check Grace Period</h3>

<p>Set the amount of time after the delay before health check failures count toward the maximum number of consecutive failures:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"health_check_grace_period_sec"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"The period of time after the delay (in seconds) before health-check failures count towards the maximum consecutive failures."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="mi">10</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">BROKER_HEALTH_CHECK_GRACE_SEC</code>: <code class="highlighter-rouge">10</code></li>
</ul>

<h3 id="maximum-consecutive-health-check-failures">Maximum Consecutive Health Check Failures</h3>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"health_check_max_consecutive_failures"</span><span class="p">:{</span><span class="w">
            </span><span class="nt">"description"</span><span class="p">:</span><span class="s2">"The the number of consecutive failures which cause a Broker process to exit."</span><span class="p">,</span><span class="w">
            </span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"number"</span><span class="p">,</span><span class="w">
            </span><span class="nt">"default"</span><span class="p">:</span><span class="mi">3</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li><strong>DC/OS web interface</strong>: Set the environment variable <code class="highlighter-rouge">BROKER_HEALTH_CHECK_MAX_FAILURES</code>: <code class="highlighter-rouge">3</code></li>
</ul>


</div>
</div>
</body>

</html>
