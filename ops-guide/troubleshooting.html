<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">








<head>
<title>Operations Guide: Troubleshooting</title>
<link rel="stylesheet" type="text/css" media="all" href="../style/layout.css" />
<link rel="shortcut icon" type="image/png" href="https://mesosphere.com/favicon.ico"/>
<!-- The Dropdown library is written by Stephen Morley, licensed CC0 1.0 Universal (Public Domain Dedication)-->
<link rel="stylesheet" type="text/css" media="all" href="../style/Dropdown.css" />
<script src="../style/Dropdown.js"></script>
<style type="text/css">
/* set the background color of menu items */
.dropdown, .dropdown ul { background: #555555; clear: both; }
/* set the background color of active items */
.dropdown li:hover > a, .dropdown li:hover > span, .dropdown li.dropdownOpen > a, .dropdown li.dropdownOpen > span { background: #af87e0; }
/* pad items, set their text color, and fade their background color */
.dropdown a, .dropdown span { padding: 0.25em 0.5em; color: white; transition: background 0.2s; }
/* show '+' on expandable items */
.dropdown span:after { content: " +"; }

/* toc style: remove extra margin between elements */
.section-nav ul { margin: 0; }
</style>
</head>

<body>
<div id="wrapper">

<a href="..">
<img style="float: left; margin-bottom: 2em" src="https://mesosphere.com/wp-content/themes/mesosphere/library/images/assets/dcos-sdk-logo.png" width="250" alt="DC/OS Software Development Kit" />
</a>
<img style="float: right" src="https://img.shields.io/badge/Status-Alpha-BF97F0.svg?style=flat-square" alt="Status: Alpha" />

<ul class="dropdown" style="clear: both">
  <li>
    <a href="..">Home</a>
  </li>
  <li>
    <span>Documentation</span>
    <ul>
      
      
      
      
      <li><a href="../operations-guide.html">SDK Operations Guide</a></li>
      
      
      
      
      
      <li><a href="../developer-guide.html">SDK Developer Guide</a></li>
      
      
      
      <li><a href="../yaml-reference.html">YAML Reference</a></li>
      
      
      
      <li><a href="../faq.html">Frequently Asked Questions</a></li>
      
      
      
      <li><a href="../glossary.html">Glossary</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li><a href="../reference/api">Javadoc Reference</a></li>
      <li><a href="../reference/swagger-api">REST APIs</a></li>
    </ul>
  </li>
  <li>
    <span>Tutorials</span>
    <ul>
      
      
      
      <li><a href="../tutorials/secrets-tutorial.html">Secrets Tutorial</a></li>
      
      <li><a href="../tutorials/kafka-tutorial.html">Kafka Tutorial</a></li>
      
    </ul>
  </li>
  <li>
    <span>Services</span>
    <ul>
      
      
      
      
      <li>
        
        <span>Cassandra</span>
        
        <ul>
          
          
          
          <li><a href="../services/cassandra/install.html">Install and Customize</a></li>
          
          
          
          <li><a href="../services/cassandra/service-settings.html">Service Settings</a></li>
          
          
          
          <li><a href="../services/cassandra/cassandra-settings.html">Cassandra Settings</a></li>
          
          
          
          <li><a href="../services/cassandra/node-settings.html">Node Settings</a></li>
          
          
          
          <li><a href="../services/cassandra/uninstall.html">Uninstall</a></li>
          
          
          
          <li><a href="../services/cassandra/quick-start.html">Quick Start</a></li>
          
          
          
          <li><a href="../services/cassandra/connecting-clients.html">Connecting Clients</a></li>
          
          
          
          <li><a href="../services/cassandra/managing.html">Managing</a></li>
          
          
          
          <li><a href="../services/cassandra/api-reference.html">API Reference</a></li>
          
          
          
          <li><a href="../services/cassandra/disaster-recovery.html">Disaster Recovery</a></li>
          
          
          
          <li><a href="../services/cassandra/troubleshooting.html">Troubleshooting</a></li>
          
          
          
          <li><a href="../services/cassandra/limitations.html">Limitations</a></li>
          
          
          
          <li><a href="../services/cassandra/supported-versions.html">Supported Versions</a></li>
          
          
          
          <li><a href="../services/cassandra/release-notes.html">Release Notes</a></li>
          
          
          
          <li><a href="../services/cassandra/upgrade.html">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Elastic</span>
        
        <ul>
          
          
          
          <li><a href="../services/elastic/install.html">Install and Customize</a></li>
          
          
          
          <li><a href="../services/elastic/elastic-x-pack.html">X-Pack</a></li>
          
          
          
          <li><a href="../services/elastic/custom-elasticsearch-yaml.html">Custom Elasticsearch YAML</a></li>
          
          
          
          <li><a href="../services/elastic/uninstall.html">Uninstall</a></li>
          
          
          
          <li><a href="../services/elastic/quick-start.html">Quick Start</a></li>
          
          
          
          <li><a href="../services/elastic/connecting-clients.html">Connecting Clients</a></li>
          
          
          
          <li><a href="../services/elastic/managing.html">Managing</a></li>
          
          
          
          <li><a href="../services/elastic/api-reference.html">API Reference</a></li>
          
          
          
          <li><a href="../services/elastic/disaster-recovery.html">Disaster Recovery</a></li>
          
          
          
          <li><a href="../services/elastic/troubleshooting.html">Troubleshooting</a></li>
          
          
          
          <li><a href="../services/elastic/limitations.html">Limitations</a></li>
          
          
          
          <li><a href="../services/elastic/supported-versions.html">Supported Versions</a></li>
          
          
          
          <li><a href="../services/elastic/release-notes.html">Release Notes</a></li>
          
          
          
          <li><a href="../services/elastic/upgrade.html">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>HDFS</span>
        
        <ul>
          
          
          
          <li><a href="../services/hdfs/install.html">Install and Customize</a></li>
          
          
          
          <li><a href="../services/hdfs/kerberos.html">Kerberos</a></li>
          
          
          
          <li><a href="../services/hdfs/uninstall.html">Uninstall</a></li>
          
          
          
          <li><a href="../services/hdfs/quick-start.html">Quick Start</a></li>
          
          
          
          <li><a href="../services/hdfs/connecting-clients.html">Connecting Clients</a></li>
          
          
          
          <li><a href="../services/hdfs/managing.html">Managing</a></li>
          
          
          
          <li><a href="../services/hdfs/api-reference.html">API Reference</a></li>
          
          
          
          <li><a href="../services/hdfs/troubleshooting.html">Troubleshooting</a></li>
          
          
          
          <li><a href="../services/hdfs/limitations.html">Limitations</a></li>
          
          
          
          <li><a href="../services/hdfs/supported-versions.html">Supported Versions</a></li>
          
          
          
          <li><a href="../services/hdfs/release-notes.html">Release Notes</a></li>
          
          
          
          <li><a href="../services/hdfs/upgrade.html">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Kafka</span>
        
        <ul>
          
          
          
          <li><a href="../services/kafka/install.html">Install and Customize</a></li>
          
          
          
          <li><a href="../services/kafka/kerberos.html">Kerberos</a></li>
          
          
          
          <li><a href="../services/kafka/ssl-auth.html">SSL Auth</a></li>
          
          
          
          <li><a href="../services/kafka/uninstall.html">Uninstall</a></li>
          
          
          
          <li><a href="../services/kafka/quick-start.html">Quick Start</a></li>
          
          
          
          <li><a href="../services/kafka/connecting-clients.html">Connecting Clients</a></li>
          
          
          
          <li><a href="../services/kafka/managing.html">Managing</a></li>
          
          
          
          <li><a href="../services/kafka/api-reference.html">API Reference</a></li>
          
          
          
          <li><a href="../services/kafka/troubleshooting.html">Troubleshooting</a></li>
          
          
          
          <li><a href="../services/kafka/limitations.html">Limitations</a></li>
          
          
          
          <li><a href="../services/kafka/supported-versions.html">Supported Versions</a></li>
          
          
          
          <li><a href="../services/kafka/release-notes.html">Release Notes</a></li>
          
          
          
          <li><a href="../services/kafka/upgrade.html">Upgrade</a></li>
          
          
        </ul>
      </li>
      
    </ul>
  </li>
  <li><a href="https://github.com/mesosphere/dcos-commons/blob/master/CONTRIBUTING.md">Contributing</a></li>
  <li><a href="http://chat.dcos.io" target="_blank">Slack</a></li>
</ul>
<h1>Operations Guide: Troubleshooting</h1>
<div id="content">

<p>This section goes over some common pitfalls and how to fix them.</p>

<h2 id="tasks-not-deploying--resource-starvation">Tasks not deploying / Resource starvation</h2>

<p>When the Scheduler is performing offer evaluation, it will log its decisions about offers it has received. This can be useful in the common case of determining why a task is failing to deploy.</p>

<p>In this example we have a newly-deployed <code class="highlighter-rouge">dse</code> Scheduler that isn’t deploying the third <code class="highlighter-rouge">dsenode</code> task that we requested. This can often happen if our cluster doesn’t have any machines with enough room to run the task.</p>

<p>In recent versions of the Scheduler, a Scheduler endpoint at <code class="highlighter-rouge">http://yourcluster.com/service/&lt;servicename&gt;/v1/debug/offers</code> will display an HTML table containing a summary of recently-evaluated offers. This table’s contents are currently very similar to what can be found in logs, but in a slightly more accessible format. Alternately, we can look at the Scheduler’s logs in <code class="highlighter-rouge">stdout</code> (or <code class="highlighter-rouge">stderr</code> in older SDK versions).</p>

<p>When looking at either the Offers debug endpoint, or at the Scheduler logs directly, we find several examples of offers that were insufficient to deploy the remaining node. It’s important to remember that <em>offers will regularly be rejected</em> due to not meeting the needs of a deployed task and that this is <em>completely normal</em>. What we’re looking for is a common theme across those rejections that would indicate what we’re missing.</p>

<p>From scrolling through the scheduler logs, we see a couple of patterns. First, there are failures like this, where the only thing missing is CPUs. The remaining task requires 2 CPUs but this offer apparently didn’t have enough:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO  2017-04-25 19:17:13,846 [pool-8-thread-1] com.mesosphere.sdk.offer.evaluate.OfferEvaluator:evaluate(69): Offer 1: failed 1 of 14 evaluation stages:
  PASS(PlacementRuleEvaluationStage): No placement rule defined
  PASS(ExecutorEvaluationStage): Offer contains the matching Executor ID
  PASS(ResourceEvaluationStage): Offer contains sufficient 'cpus': requirement=type: SCALAR scalar { value: 0.5 }
  PASS(ResourceEvaluationStage): Offer contains sufficient 'mem': requirement=type: SCALAR scalar { value: 500.0 }
  PASS(LaunchEvaluationStage): Added launch information to offer requirement
  FAIL(ResourceEvaluationStage): Failed to satisfy required resource 'cpus': name: "cpus" type: SCALAR scalar { value: 2.0 } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
  PASS(ResourceEvaluationStage): Offer contains sufficient 'mem': requirement=type: SCALAR scalar { value: 8000.0 }
  PASS(MultiEvaluationStage): All child stages passed
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 9042 end: 9042 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 9160 end: 9160 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 7000 end: 7000 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 7001 end: 7001 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 8609 end: 8609 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 8182 end: 8182 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 7199 end: 7199 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 21621 end: 21621 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 8983 end: 8983 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 7077 end: 7077 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 7080 end: 7080 } }
    PASS(PortEvaluationStage): Offer contains sufficient 'ports': requirement=type: RANGES ranges { range { begin: 7081 end: 7081 } }
  PASS(VolumeEvaluationStage): Offer contains sufficient 'disk'
  PASS(VolumeEvaluationStage): Offer contains sufficient 'disk'
  PASS(VolumeEvaluationStage): Offer contains sufficient 'disk'
  PASS(VolumeEvaluationStage): Offer contains sufficient 'disk'
  PASS(LaunchEvaluationStage): Added launch information to offer requirement
  PASS(ReservationEvaluationStage): Added reservation information to offer requirement
</code></pre></div></div>

<p>If we scroll up from this rejection summary, we find a message describing what the agent had offered in terms of CPU:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO  2017-04-25 19:17:13,834 [pool-8-thread-1] com.mesosphere.sdk.offer.MesosResourcePool:consumeUnreservedMerged(239): Offered quantity of cpus is insufficient: desired type: SCALAR scalar { value: 2.0 }, offered type: SCALAR scalar { value: 0.5 }
</code></pre></div></div>

<p>Understandably, our Scheduler is refusing to launch a DSE node on a system with 0.5 remaining CPUs when the DSE node needs 2.0 CPUs.</p>

<p>Another pattern we see is a message like this, where the offer is being rejected for several reasons:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO  2017-04-25 19:17:14,849 [pool-8-thread-1] com.mesosphere.sdk.offer.evaluate.OfferEvaluator:evaluate(69): Offer 1: failed 6 of 14 evaluation stages:
  PASS(PlacementRuleEvaluationStage): No placement rule defined
  PASS(ExecutorEvaluationStage): Offer contains the matching Executor ID
  FAIL(ResourceEvaluationStage): Failed to satisfy required resource 'cpus': name: "cpus" type: SCALAR scalar { value: 0.5 } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
  PASS(ResourceEvaluationStage): Offer contains sufficient 'mem': requirement=type: SCALAR scalar { value: 500.0 }
  PASS(LaunchEvaluationStage): Added launch information to offer requirement
  FAIL(ResourceEvaluationStage): Failed to satisfy required resource 'cpus': name: "cpus" type: SCALAR scalar { value: 2.0 } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
  FAIL(ResourceEvaluationStage): Failed to satisfy required resource 'mem': name: "mem" type: SCALAR scalar { value: 8000.0 } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
  FAIL(MultiEvaluationStage): Failed to pass all child stages
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 9042 end: 9042 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 9160 end: 9160 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 7000 end: 7000 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 7001 end: 7001 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 8609 end: 8609 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 8182 end: 8182 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 7199 end: 7199 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 21621 end: 21621 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 8983 end: 8983 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 7077 end: 7077 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 7080 end: 7080 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
    FAIL(PortEvaluationStage): Failed to satisfy required resource 'ports': name: "ports" type: RANGES ranges { range { begin: 7081 end: 7081 } } role: "dse-role" reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
  FAIL(VolumeEvaluationStage): Failed to satisfy required volume 'disk': name: "disk" type: SCALAR scalar { value: 10240.0 } role: "dse-role" disk { persistence { id: "" principal: "dse-principal" } volume { container_path: "dse-data" mode: RW } } reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
  PASS(VolumeEvaluationStage): Offer contains sufficient 'disk'
  PASS(VolumeEvaluationStage): Offer contains sufficient 'disk'
  FAIL(VolumeEvaluationStage): Failed to satisfy required volume 'disk': name: "disk" type: SCALAR scalar { value: 10240.0 } role: "dse-role" disk { persistence { id: "" principal: "dse-principal" } volume { container_path: "solr-data" mode: RW } } reservation { principal: "dse-principal" labels { labels { key: "resource_id" value: "" } } }
  PASS(LaunchEvaluationStage): Added launch information to offer requirement
  PASS(ReservationEvaluationStage): Added reservation information to offer requirement
</code></pre></div></div>

<p>In this case, we see that none of the ports our DSE task needs are available on this system (not to mention the lack of sufficient CPU and RAM). This will typically happen when we’re looking at an agent that we’ve already deployed to. The agent in question here is likely running either <code class="highlighter-rouge">dsenode-0</code> or <code class="highlighter-rouge">dsenode-1</code>, where we had already reserved those ports ourselves.</p>

<p>We’re seeing that none of the remaining agents in the cluster have room to fit our <code class="highlighter-rouge">dsenode-2</code>. To resolve this, we need to either add more agents to the DC/OS cluster or we need to reduce the requirements of our service to make it fit. In the latter case, be aware of any performance issues that may result if resource usage is reduced too far. Insufficient CPU quota will result in throttled tasks, and insufficient RAM quota will result in OOMed tasks.</p>

<p>This is a good example of the kind of diagnosis you can perform by skimming the SDK Scheduler logs.</p>

<h2 id="accidentially-deleted-marathon-task-but-not-service">Accidentially deleted Marathon task but not service</h2>

<p>A common user mistake is to remove the Scheduler task from Marathon, which doesn’t do anything to uninstall the service tasks themselves. If you do this, you have two options:</p>

<h3 id="uninstall-the-rest-of-the-service">Uninstall the rest of the service</h3>

<p>If you really wanted to uninstall the service, you just need to complete the normal <code class="highlighter-rouge"><span class="k">package</span> <span class="n">uninstall</span></code> steps described under <a href="#uninstall">Uninstall</a>.</p>

<h3 id="recover-the-scheduler">Recover the Scheduler</h3>

<p>If you want to bring the Scheduler back, you can do a <code class="highlighter-rouge">dcos package install</code> using the options that you had configured before. This will re-install a new Scheduler that should match the previous one (assuming you got your options right), and it will resume where it left off. To ensure that you don’t forget the options your services are configured with, we recommend keeping a copy of your service’s <code class="highlighter-rouge">options.json</code> in source control so that you can easily recover it later. See also <a href="#initial-service-configuration">Initial configuration</a>.</p>

<h2 id="framework-has-been-removed">‘Framework has been removed’</h2>

<p>Long story short, you forgot to run <code class="highlighter-rouge">janitor.py</code> the last time you ran the service. See <a href="#uninstall">Uninstall</a> for steps on doing that. In case you’re curious, here’s what happened:</p>

<ol>
  <li>You ran <code class="highlighter-rouge">dcos package uninstall</code>. This destroyed the scheduler and its associated tasks, <em>but didn’t clean up its reserved resources</em>.</li>
  <li>Later on, you tried to reinstall the service. The Scheduler came up and found an entry in ZooKeeper with the previous framework ID, which would have been cleaned up by <code class="highlighter-rouge">janitor.py</code>. The Scheduler tried to re-register using that framework ID.</li>
  <li>Mesos returned an error because it knows that framework ID is no longer valid. Hence the confusing ‘Framework has been removed’ error.</li>
</ol>

<h2 id="stuck-deployments">Stuck deployments</h2>

<p>You can sometimes get into valid situations where a deployment is being blocked by a repair operation or vice versa. For example, say you were rolling out an update to a 500 node Cassandra cluster. The deployment gets paused at node #394 because it’s failing to come back, and, for whatever reason, we don’t have the time or the inclination to <code class="highlighter-rouge">pod replace</code> it and wait for it to come back.</p>

<p>In this case, we can use <code class="highlighter-rouge">plan</code> commands to force the Scheduler to skip node #394 and proceed with the rest of the deployment:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos cassandra plan status deploy
<span class="o">{</span>
  <span class="s2">"phases"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"id"</span>: <span class="s2">"aefd33e3-af78-425e-ad2e-6cc4b0bc1907"</span>,
      <span class="s2">"name"</span>: <span class="s2">"cassandra-phase"</span>,
      <span class="s2">"steps"</span>: <span class="o">[</span>
        ...
        <span class="o">{</span> <span class="s2">"id"</span>: <span class="s2">"f108a6a8-d41f-4c49-a1c0-4a8540876f6f"</span>, <span class="s2">"name"</span>: <span class="s2">"node-393:[node]"</span>, <span class="s2">"status"</span>: <span class="s2">"COMPLETE"</span> <span class="o">}</span>,
        <span class="o">{</span> <span class="s2">"id"</span>: <span class="s2">"83a7f8bc-f593-452a-9ceb-627d101da545"</span>, <span class="s2">"name"</span>: <span class="s2">"node-394:[node]"</span>, <span class="s2">"status"</span>: <span class="s2">"PENDING"</span> <span class="o">}</span>, <span class="c"># stuck here</span>
        <span class="o">{</span> <span class="s2">"id"</span>: <span class="s2">"61ce9d7d-b023-4a8a-9191-bfa261ace064"</span>, <span class="s2">"name"</span>: <span class="s2">"node-395:[node]"</span>, <span class="s2">"status"</span>: <span class="s2">"PENDING"</span> <span class="o">}</span>,
        ...
      <span class="o">]</span>,
      <span class="s2">"status"</span>: <span class="s2">"IN_PROGRESS"</span>
    <span class="o">}</span>,
    ...
  <span class="o">]</span>,
  <span class="s2">"errors"</span>: <span class="o">[]</span>,
  <span class="s2">"status"</span>: <span class="s2">"IN_PROGRESS"</span>
<span class="o">}</span>
<span class="nv">$ </span>dcos plan force deploy cassandra-phase node-394:[node]
<span class="o">{</span>
  <span class="s2">"message"</span>: <span class="s2">"Received cmd: forceComplete"</span>
<span class="o">}</span>
</code></pre></div></div>

<p>After forcing the <code class="highlighter-rouge">node-394:[node]</code> step, we can then see that the Plan shows it in a <code class="highlighter-rouge">COMPLETE</code> state, and that the Plan is proceeding with <code class="highlighter-rouge">node-395</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dcos cassandra plan status deploy
{
  "phases": [
    {
      "id": "aefd33e3-af78-425e-ad2e-6cc4b0bc1907",
      "name": "cassandra-phase",
      "steps": [
        ...
        { "id": "f108a6a8-d41f-4c49-a1c0-4a8540876f6f", "name": "node-393:[node]", "status": "COMPLETE" },
        { "id": "83a7f8bc-f593-452a-9ceb-627d101da545", "name": "node-394:[node]", "status": "COMPLETE" },
        { "id": "61ce9d7d-b023-4a8a-9191-bfa261ace064", "name": "node-395:[node]", "status": "PENDING" },
        ...
      ],
      "status": "IN_PROGRESS"
    },
    ...
  ],
  "errors": [],
  "status": "IN_PROGRESS"
}
</code></pre></div></div>

<p>If we want to go back and fix the deployment of that node, we can simply force the scheduler to treat it as a pending operation again:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dcos plan restart deploy cassandra-phase node-394:[node]
{
  "message": "Received cmd: restart"
}
</code></pre></div></div>

<p>Now, we see that the step is again marked as <code class="highlighter-rouge">PENDING</code> as the Scheduler again attempts to redeploy that node:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dcos cassandra plan status deploy
{
  "phases": [
    {
      "id": "aefd33e3-af78-425e-ad2e-6cc4b0bc1907",
      "name": "cassandra-phase",
      "steps": [
        ...
        { "id": "f108a6a8-d41f-4c49-a1c0-4a8540876f6f", "name": "node-393:[node]", "status": "COMPLETE" },
        { "id": "83a7f8bc-f593-452a-9ceb-627d101da545", "name": "node-394:[node]", "status": "PENDING" },
        { "id": "61ce9d7d-b023-4a8a-9191-bfa261ace064", "name": "node-395:[node]", "status": "COMPLETE" },
        ...
      ],
      "status": "IN_PROGRESS"
    },
    ...
  ],
  "errors": [],
  "status": "IN_PROGRESS"
}
</code></pre></div></div>

<p>This example shows how steps in the deployment Plan (or any other Plan) can be manually retriggered or forced to a completed state by querying the Scheduler. This doesn’t come up often, but it can be a useful tool in certain situations.</p>

<p><strong>Note:</strong> The <code class="highlighter-rouge">dcos plan</code> commands will also accept UUID <code class="highlighter-rouge">id</code> values instead of the <code class="highlighter-rouge">name</code> values for the <code class="highlighter-rouge">phase</code> and <code class="highlighter-rouge">step</code> arguments. Providing UUIDs avoids the possibility of a race condition where we view the plan, then it changes structure, then we change a plan step that isn’t the same one we were expecting (but which had the same name).</p>

<h3 id="deleting-a-task-in-zookeeper-to-forcibly-wipe-that-task">Deleting a task in ZooKeeper to forcibly wipe that task</h3>

<p>If the scheduler is still failing after <code class="highlighter-rouge">pod replace &lt;name&gt;</code> to clear a task, a last resort is to use <a href="#ZooKeeperexhibitor">Exhibitor</a> to delete the offending task from the Scheduler’s ZooKeeper state, and then to restart the Scheduler task in Marathon so that it picks up the change. After the Scheduler restarts, it will do the following:</p>
<ul>
  <li>Automatically unreserve the task’s previous resources with Mesos because it doesn’t recognize them anymore (via the Resource Cleanup operation described earlier).</li>
  <li>Automatically redeploy the task on a new agent.</li>
</ul>

<p><strong>Note:</strong> This operation can easily lead to a completely broken service. <strong>Do this at your own risk.</strong> <a href="img/ops-guide-exhibitor-delete-task.png">Break glass in case of emergency</a></p>

<h3 id="oomed-task">OOMed task</h3>

<p>Your tasks can be killed from an OOM if you didn’t give them sufficient resources. This will manifest as sudden <code class="highlighter-rouge">Killed</code> messages in <a href="#task-logs">Task logs</a>, sometimes consistently but often not. To verify that the cause is an OOM, the following places can be checked:</p>
<ul>
  <li>Check <a href="#scheduler-logs">Scheduler logs</a> (or <code class="highlighter-rouge">dcos &lt;svcname&gt; pod status &lt;podname&gt;)</code> to see TaskStatus updates from mesos for a given failed pod.</li>
  <li>Check <a href="#mesos-agent-logs">Agent logs</a> directly for mention of the Mesos Agent killing a task due to excess memory usage.</li>
</ul>

<p>After you’ve been able to confirm that the problem is indeed an OOM, you can solve it by either <a href="#updating-service-configuration">updating the service configuration</a> to reserve more memory, or configuring the underlying service itself to use less memory (assuming the option is available).</p>

</div>
</div>
</body>

</html>
